<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminRepartos Pro (Firebase)</title>
    <!-- SheetJS para Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK (modular compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    <style>
        /* (mismos estilos que antes, sin cambios) */
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
        body { background: #f4f6f9; padding: 1rem; min-height: 100vh; display: flex; justify-content: center; }
        #app { max-width: 1400px; width: 100%; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: #1e2b3a; color: white; padding: 1rem 2rem; display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem; }
        header h1 { font-size: 1.8rem; font-weight: 400; margin-right: auto; }
        .nav-btn { background: transparent; border: none; color: #ccc; font-size: 1rem; padding: 0.5rem 1rem; cursor: pointer; border-radius: 30px; transition: 0.2s; }
        .nav-btn:hover { background: #2c3e50; color: white; }
        .nav-btn.active { background: #3b4e62; color: white; font-weight: 500; }
        main { padding: 2rem; }
        .views-container > div { display: none; }
        .views-container > div.active-view { display: block; }
        h2 { margin-bottom: 1.5rem; color: #1e2b3a; font-weight: 400; border-bottom: 2px solid #eaeef2; padding-bottom: 0.5rem; }
        button, .btn { background: #1e2b3a; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 30px; font-size: 0.95rem; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        button:hover { background: #2c3e50; }
        button.secondary { background: white; color: #1e2b3a; border: 1px solid #1e2b3a; }
        button.secondary:hover { background: #f0f3f7; }
        .card { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eaeef2; margin-bottom: 2rem; }
        .flex-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
        .search-box { flex: 1; min-width: 250px; padding: 0.7rem 1rem; border-radius: 30px; border: 1px solid #d0d9e2; font-size: 1rem; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .filter-group input, .filter-group select { padding: 0.5rem 1rem; border-radius: 30px; border: 1px solid #d0d9e2; font-size: 0.95rem; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eaeef2; vertical-align: top; }
        th { background: #f8fafc; font-weight: 500; color: #2c3e50; }
        tr:hover { background: #f9fcff; }
        .badge { display: inline-block; padding: 0.25rem 0.8rem; border-radius: 30px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .badge.pendiente { background: #fff3cd; color: #856404; }
        .badge.entregado { background: #d4edda; color: #155724; }
        .badge.incompleto { background: #f8d7da; color: #721c24; }
        .badge:hover { filter: brightness(0.95); }
        .actions-cell { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .icon-btn { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.2rem 0.5rem; border-radius: 8px; line-height: 1; }
        .icon-btn:hover { background: #e9ecef; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .form-group { margin-bottom: 1rem; position: relative; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 500; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem 1rem; border-radius: 30px; border: 1px solid #d0d9e2; font-size: 1rem; }
        .form-group textarea { border-radius: 16px; resize: vertical; min-height: 80px; }
        .photo-preview { max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid #ccc; margin-top: 0.5rem; }
        .product-item { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .product-item input { flex: 1; }
        .remove-product { background: #f8d7da; color: #721c24; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .file-upload { border: 2px dashed #b8c5d0; border-radius: 30px; padding: 1.5rem; text-align: center; background: #fcfdff; cursor: pointer; }
        .file-upload:hover { background: #f2f6fa; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #1e2b3a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-menu { position: absolute; background: white; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 0.5rem; z-index: 100; display: none; }
        .status-menu button { display: block; width: 100%; background: white; border: none; padding: 0.5rem 1rem; text-align: left; border-radius: 30px; margin: 2px 0; color: #1e2b3a; }
        .status-menu button:hover { background: #f0f3f7; }
        .image-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .image-modal .close { position: absolute; top: 20px; right: 30px; font-size: 2rem; color: white; cursor: pointer; }
        .inline-add { display: flex; gap: 0.5rem; align-items: center; }
        .inline-add select { flex: 1; }
        .inline-add button { width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; padding: 0; }
        .product-list { list-style: disc; padding-left: 1.2rem; margin: 0; }
        .product-list li { margin-bottom: 0.2rem; }
        .date-filter { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .date-filter input { padding: 0.5rem; border-radius: 30px; border: 1px solid #d0d9e2; }
        .global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .global-loader.hidden { display: none; }
    </style>
</head>
<body>
<div id="app">
    <header>
        <h1>üì¶ AdminRepartos (Firebase)</h1>
        <button class="nav-btn" data-view="orders">üìã Pedidos</button>
        <button class="nav-btn" data-view="customers">üë• Clientes</button>
        <button class="nav-btn" data-view="products">üì¶ Productos</button>
        <button class="nav-btn" data-view="backup">üíæ Backup</button>
    </header>
    <main>
        <div class="views-container" id="viewsContainer">
            <!-- Pedidos -->
            <div id="view-orders" class="active-view">
                <div class="flex-row">
                    <h2>üìã Lista de Pedidos</h2>
                    <button id="newOrderBtn" class="secondary">‚ûï Nuevo pedido</button>
                </div>
                <div class="flex-row">
                    <input type="text" id="searchOrders" class="search-box" placeholder="üîç Buscar (cliente, tel√©fono, producto...)">
                    <div class="filter-group">
                        <select id="statusFilter">
                            <option value="todos">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="entregado">Entregado</option>
                            <option value="incompleto">Incompleto</option>
                        </select>
                        <div class="date-filter">
                            <input type="date" id="dateFrom" placeholder="Desde">
                            <input type="date" id="dateTo" placeholder="Hasta">
                        </div>
                    </div>
                </div>
                <div id="ordersList"></div>
            </div>
            <!-- Clientes -->
            <div id="view-customers">
                <div class="flex-row">
                    <h2>üë• Clientes</h2>
                    <button id="newCustomerBtn" class="secondary">‚ûï Nuevo cliente</button>
                </div>
                <div id="customersList"></div>
            </div>
            <!-- Productos -->
            <div id="view-products">
                <h2>üì¶ Productos (para autocompletado)</h2>
                <div class="card">
                    <p style="margin-bottom:1rem">Sub√≠ un archivo CSV (columna "nombre") o Excel (XLSX, XLS) para cargar productos.</p>
                    <div class="file-upload" id="dropZone">
                        üìÇ Arrastr√° o hac√© clic para seleccionar archivo (CSV o Excel)
                        <input type="file" id="productFile" accept=".csv, text/csv, .xls, .xlsx, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display: none;">
                    </div>
                    <div id="productList" style="margin-top:2rem"></div>
                    <button id="clearProducts" class="secondary" style="margin-top:1rem">üóëÔ∏è Limpiar productos</button>
                </div>
            </div>
            <!-- Backup -->
            <div id="view-backup">
                <h2>üíæ Respaldos</h2>
                <div class="card">
                    <button id="exportBackup" style="width:100%; margin-bottom:1rem">üì• Exportar datos (backup.json)</button>
                    <div class="file-upload" id="importZone">
                        üìÇ Arrastr√° o hac√© clic para restaurar backup (JSON)
                        <input type="file" id="importFile" accept=".json, application/json" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal para pedido -->
<div id="orderModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
    <div style="background:white; border-radius:30px; width:90%; max-width:800px; max-height:90vh; overflow:auto; padding:2rem;">
        <h3 id="modalTitle">‚ûï Nuevo Pedido</h3>
        <form id="orderForm">
            <input type="hidden" id="orderId">
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <div class="inline-add">
                            <select id="customerSelect" required></select>
                            <button type="button" id="quickAddCustomerBtn" class="secondary" style="width:40px; height:40px; border-radius:50%;">‚ûï</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="datetime-local" id="orderDate" required>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="orderStatus">
                            <option value="pendiente">Pendiente</option>
                            <option value="entregado">Entregado</option>
                            <option value="incompleto">Incompleto</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Comentarios</label>
                        <textarea id="orderComments" placeholder="Notas del pedido..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Foto del ticket</label>
                        <input type="file" id="ticketPhoto" accept="image/*">
                        <div id="photoPreviewContainer"></div>
                    </div>
                </div>
            </div>
            <fieldset style="border:1px solid #eaeef2; border-radius:20px; padding:1rem; margin:1rem 0;">
                <legend>üì¶ Productos en el pedido</legend>
                <div id="productsContainer"></div>
                <button type="button" id="addProductBtn" class="secondary" style="margin-top:0.5rem">‚ûï Agregar producto</button>
            </fieldset>
            <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:2rem;">
                <button type="button" id="cancelOrderBtn" class="secondary">Cancelar</button>
                <button type="submit" id="saveOrderBtn">Guardar pedido</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal mini para cliente r√°pido -->
<div id="quickCustomerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1100;">
    <div style="background:white; border-radius:30px; width:90%; max-width:400px; padding:2rem;">
        <h3>‚ûï Cliente R√°pido</h3>
        <form id="quickCustomerForm">
            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="quickName" required>
            </div>
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="text" id="quickPhone">
            </div>
            <div class="form-group">
                <label>Direcci√≥n</label>
                <input type="text" id="quickAddress">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="quickEmail">
            </div>
            <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:1.5rem;">
                <button type="button" id="cancelQuickBtn" class="secondary">Cancelar</button>
                <button type="submit" id="saveQuickBtn">Guardar y usar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para imagen -->
<div id="imageModal" class="image-modal" style="display:none;" onclick="this.style.display='none'">
    <span class="close">&times;</span>
    <img id="modalImage" src="" alt="Foto ticket">
</div>

<!-- Modal para cliente normal (editar/agregar) -->
<div id="customerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
    <div style="background:white; border-radius:30px; width:90%; max-width:500px; padding:2rem;">
        <h3 id="customerModalTitle">üë§ Nuevo Cliente</h3>
        <form id="customerForm">
            <input type="hidden" id="customerId">
            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="customerName" required>
            </div>
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="text" id="customerPhone">
            </div>
            <div class="form-group">
                <label>Direcci√≥n</label>
                <input type="text" id="customerAddress">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="customerEmail">
            </div>
            <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:2rem;">
                <button type="button" id="cancelCustomerBtn" class="secondary">Cancelar</button>
                <button type="submit" id="saveCustomerBtn">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Loader global -->
<div id="globalLoader" class="global-loader hidden">
    <div class="spinner" style="width:50px; height:50px;"></div>
</div>

<script>
    (function() {
        // --- Configuraci√≥n de Firebase (¬°REEMPLAZA CON TUS DATOS!) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAquiVaTuApiKey",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Habilitar persistencia offline (opcional, pero recomendado)
        db.enablePersistence({ synchronizeTabs: true })
          .catch(err => console.warn('Error de persistencia:', err));

        // --- Referencias a colecciones ---
        const customersCol = db.collection('customers');
        const productsCol = db.collection('products');
        const ordersCol = db.collection('orders');

        // --- Estado local (cach√© para renderizado r√°pido) ---
        let customers = [];
        let products = [];
        let orders = [];

        // --- Loader ---
        const loader = document.getElementById('globalLoader');
        function showLoader() { loader.classList.remove('hidden'); }
        function hideLoader() { loader.classList.add('hidden'); }

        // --- Funciones para cargar datos iniciales y escuchar cambios ---
        function loadCustomers() {
            return customersCol.orderBy('name').get().then(snapshot => {
                customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        }
        function loadProducts() {
            return productsCol.orderBy('name').get().then(snapshot => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateProductDatalist();
            });
        }
        function loadOrders() {
            return ordersCol.orderBy('date', 'desc').get().then(snapshot => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        }

        // Carga inicial de todos los datos
        async function loadAllData() {
            showLoader();
            try {
                await Promise.all([loadCustomers(), loadProducts(), loadOrders()]);
                renderView(currentView);
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al conectar con Firebase. Revis√° la consola.');
            } finally {
                hideLoader();
            }
        }

        // Escuchas en tiempo real (opcional, pero muy √∫til para equipos)
        function subscribeToCustomers() {
            customersCol.orderBy('name').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified' || change.type === 'removed') {
                        // Recargar completa para simplificar (podr√≠a optimizarse)
                        loadCustomers().then(() => renderView(currentView));
                    }
                });
            });
        }
        function subscribeToProducts() {
            productsCol.orderBy('name').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(() => {
                    loadProducts().then(() => renderView(currentView));
                });
            });
        }
        function subscribeToOrders() {
            ordersCol.orderBy('date', 'desc').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(() => {
                    loadOrders().then(() => renderView(currentView));
                });
            });
        }

        // Iniciar suscripciones despu√©s de carga inicial
        function startSubscriptions() {
            subscribeToCustomers();
            subscribeToProducts();
            subscribeToOrders();
        }

        // --- Funciones CRUD con Firebase ---
        async function saveCustomer(customerData) {
            showLoader();
            try {
                if (customerData.id) {
                    // Actualizar
                    await customersCol.doc(customerData.id).set(customerData);
                } else {
                    // Crear nuevo con ID generado por Firestore
                    const docRef = await customersCol.add(customerData);
                    customerData.id = docRef.id;
                }
                // No necesitamos recargar porque la suscripci√≥n lo har√°
            } catch (error) {
                console.error('Error guardando cliente:', error);
                alert('Error al guardar cliente');
            } finally {
                hideLoader();
            }
        }

        async function deleteCustomer(id) {
            if (orders.some(o => o.customerId === id)) {
                alert('No se puede eliminar un cliente con pedidos asociados.');
                return;
            }
            if (confirm('¬øEliminar cliente?')) {
                showLoader();
                try {
                    await customersCol.doc(id).delete();
                } catch (error) {
                    console.error('Error eliminando cliente:', error);
                    alert('Error al eliminar cliente');
                } finally {
                    hideLoader();
                }
            }
        }

        async function saveProduct(productData) {
            showLoader();
            try {
                if (productData.id) {
                    await productsCol.doc(productData.id).set(productData);
                } else {
                    const docRef = await productsCol.add(productData);
                    productData.id = docRef.id;
                }
            } catch (error) {
                console.error('Error guardando producto:', error);
                alert('Error al guardar producto');
            } finally {
                hideLoader();
            }
        }

        async function deleteProduct(id) {
            if (confirm('¬øEliminar producto?')) {
                showLoader();
                try {
                    await productsCol.doc(id).delete();
                } catch (error) {
                    console.error('Error eliminando producto:', error);
                    alert('Error al eliminar producto');
                } finally {
                    hideLoader();
                }
            }
        }

        async function saveOrder(orderData, file = null) {
            showLoader();
            try {
                // Si hay archivo, subirlo a Storage
                if (file) {
                    const storageRef = storage.ref(`tickets/${orderData.id}_${Date.now()}`);
                    await storageRef.put(file);
                    const url = await storageRef.getDownloadURL();
                    orderData.ticketPhoto = url;
                } else if (!orderData.ticketPhoto) {
                    orderData.ticketPhoto = '';
                }

                if (orderData.id) {
                    await ordersCol.doc(orderData.id).set(orderData);
                } else {
                    const docRef = await ordersCol.add(orderData);
                    orderData.id = docRef.id;
                }
            } catch (error) {
                console.error('Error guardando pedido:', error);
                alert('Error al guardar pedido');
            } finally {
                hideLoader();
            }
        }

        async function deleteOrder(id) {
            if (confirm('¬øEliminar pedido?')) {
                showLoader();
                try {
                    await ordersCol.doc(id).delete();
                } catch (error) {
                    console.error('Error eliminando pedido:', error);
                    alert('Error al eliminar pedido');
                } finally {
                    hideLoader();
                }
            }
        }

        async function updateOrderStatus(id, newStatus) {
            showLoader();
            try {
                await ordersCol.doc(id).update({ status: newStatus });
            } catch (error) {
                console.error('Error actualizando estado:', error);
                alert('Error al actualizar estado');
            } finally {
                hideLoader();
            }
        }

        // --- Importaci√≥n masiva de productos desde Excel/CSV (usando Firebase) ---
        async function importProducts(newProductsArray) {
            showLoader();
            try {
                const batch = db.batch();
                newProductsArray.forEach(prod => {
                    const docRef = productsCol.doc(); // ID autom√°tico
                    batch.set(docRef, prod);
                });
                await batch.commit();
                alert('Productos importados correctamente');
            } catch (error) {
                console.error('Error importando productos:', error);
                alert('Error al importar productos');
            } finally {
                hideLoader();
            }
        }

        async function clearAllProducts() {
            if (!confirm('¬øEliminar TODOS los productos?')) return;
            showLoader();
            try {
                const snapshot = await productsCol.get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            } catch (error) {
                console.error('Error limpiando productos:', error);
                alert('Error al limpiar productos');
            } finally {
                hideLoader();
            }
        }

        // --- Backup / Restore (ahora desde Firebase) ---
        async function exportBackup() {
            showLoader();
            try {
                const [custSnap, prodSnap, orderSnap] = await Promise.all([
                    customersCol.get(),
                    productsCol.get(),
                    ordersCol.get()
                ]);
                const backup = {
                    customers: custSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    products: prodSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    orders: orderSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                };
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exportando backup:', error);
                alert('Error al exportar');
            } finally {
                hideLoader();
            }
        }

        async function importBackup(file) {
            showLoader();
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                const batch = db.batch();

                // Limpiar colecciones existentes (opcional, podr√≠amos hacer merge)
                // Para simplificar, eliminamos todo y luego insertamos
                const [custSnap, prodSnap, orderSnap] = await Promise.all([
                    customersCol.get(),
                    productsCol.get(),
                    ordersCol.get()
                ]);
                custSnap.docs.forEach(doc => batch.delete(doc.ref));
                prodSnap.docs.forEach(doc => batch.delete(doc.ref));
                orderSnap.docs.forEach(doc => batch.delete(doc.ref));

                // Agregar los nuevos
                if (data.customers) data.customers.forEach(c => {
                    const ref = customersCol.doc(c.id || undefined);
                    batch.set(ref, c);
                });
                if (data.products) data.products.forEach(p => {
                    const ref = productsCol.doc(p.id || undefined);
                    batch.set(ref, p);
                });
                if (data.orders) data.orders.forEach(o => {
                    const ref = ordersCol.doc(o.id || undefined);
                    batch.set(ref, o);
                });

                await batch.commit();
                alert('Restauraci√≥n exitosa');
            } catch (error) {
                console.error('Error importando backup:', error);
                alert('Archivo inv√°lido o error en la restauraci√≥n');
            } finally {
                hideLoader();
            }
        }

        // ----- Referencias DOM (igual que antes) -----
        const viewsContainer = document.getElementById('viewsContainer');
        const navBtns = document.querySelectorAll('.nav-btn');
        const newOrderBtn = document.getElementById('newOrderBtn');
        const searchOrders = document.getElementById('searchOrders');
        const statusFilter = document.getElementById('statusFilter');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const ordersListDiv = document.getElementById('ordersList');
        const customersListDiv = document.getElementById('customersList');
        const productListDiv = document.getElementById('productList');
        const newCustomerBtn = document.getElementById('newCustomerBtn');
        const productFile = document.getElementById('productFile');
        const dropZone = document.getElementById('dropZone');
        const clearProductsBtn = document.getElementById('clearProducts');
        const exportBackupBtn = document.getElementById('exportBackup');
        const importZone = document.getElementById('importZone');
        const importFile = document.getElementById('importFile');

        // Modales
        const orderModal = document.getElementById('orderModal');
        const quickCustomerModal = document.getElementById('quickCustomerModal');
        const customerModal = document.getElementById('customerModal');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        // Elementos dentro de modales
        const quickAddCustomerBtn = document.getElementById('quickAddCustomerBtn');
        const quickCustomerForm = document.getElementById('quickCustomerForm');
        const cancelQuickBtn = document.getElementById('cancelQuickBtn');
        const quickName = document.getElementById('quickName');
        const quickPhone = document.getElementById('quickPhone');
        const quickAddress = document.getElementById('quickAddress');
        const quickEmail = document.getElementById('quickEmail');

        const orderForm = document.getElementById('orderForm');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const addProductBtn = document.getElementById('addProductBtn');
        const productsContainer = document.getElementById('productsContainer');
        const customerSelect = document.getElementById('customerSelect');
        const orderDate = document.getElementById('orderDate');
        const orderStatus = document.getElementById('orderStatus');
        const orderComments = document.getElementById('orderComments');
        const ticketPhoto = document.getElementById('ticketPhoto');
        const photoPreviewContainer = document.getElementById('photoPreviewContainer');
        const orderIdHidden = document.getElementById('orderId');
        const modalTitle = document.getElementById('modalTitle');

        const customerForm = document.getElementById('customerForm');
        const cancelCustomerBtn = document.getElementById('cancelCustomerBtn');
        const customerIdHidden = document.getElementById('customerId');
        const customerName = document.getElementById('customerName');
        const customerPhone = document.getElementById('customerPhone');
        const customerAddress = document.getElementById('customerAddress');
        const customerEmail = document.getElementById('customerEmail');
        const customerModalTitle = document.getElementById('customerModalTitle');

        // ---- Utilidades de vista (adaptadas para usar datos locales) ----
        let currentView = 'orders';

        function setActiveView(viewId) {
            currentView = viewId;
            document.querySelectorAll('.views-container > div').forEach(div => div.classList.remove('active-view'));
            document.getElementById(`view-${viewId}`).classList.add('active-view');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-view="${viewId}"]`).classList.add('active');
            renderView(viewId);
        }

        navBtns.forEach(btn => btn.addEventListener('click', () => setActiveView(btn.dataset.view)));

        function renderView(view) {
            if (view === 'orders') renderOrders();
            if (view === 'customers') renderCustomers();
            if (view === 'products') renderProductsList();
            // backup no necesita render especial
        }

        // ---- Render Pedidos (usa datos locales, igual que antes pero con orders de Firebase) ----
        function renderOrders() {
            const filterText = searchOrders ? searchOrders.value.toLowerCase() : '';
            const filterStatus = statusFilter ? statusFilter.value : 'todos';
            const fromDate = dateFrom ? dateFrom.value : '';
            const toDate = dateTo ? dateTo.value : '';

            let filtered = orders.filter(order => {
                if (filterStatus !== 'todos' && order.status !== filterStatus) return false;
                const orderDateStr = order.date ? order.date.split('T')[0] : '';
                if (fromDate && orderDateStr < fromDate) return false;
                if (toDate && orderDateStr > toDate) return false;
                if (filterText) {
                    const customer = customers.find(c => c.id === order.customerId) || {};
                    const customerName = (customer.name || '').toLowerCase();
                    const customerPhone = (customer.phone || '').toLowerCase();
                    const customerAddress = (customer.address || '').toLowerCase();
                    const customerEmail = (customer.email || '').toLowerCase();
                    const comments = (order.comments || '').toLowerCase();
                    const productNames = order.items.map(i => i.productName.toLowerCase()).join(' ');
                    const hayMatch = customerName.includes(filterText) ||
                                    customerPhone.includes(filterText) ||
                                    customerAddress.includes(filterText) ||
                                    customerEmail.includes(filterText) ||
                                    comments.includes(filterText) ||
                                    productNames.includes(filterText);
                    if (!hayMatch) return false;
                }
                return true;
            });

            if (!ordersListDiv) return;
            if (filtered.length === 0) {
                ordersListDiv.innerHTML = '<p class="card">No hay pedidos.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Fecha</th><th>Cliente</th><th>Estado</th><th>Productos</th><th>Comentarios</th><th>Acciones</th></tr></thead><tbody>';
            filtered.forEach(order => {
                const customer = customers.find(c => c.id === order.customerId) || { name: '?' };
                const itemsList = order.items.map(i => `<li>${i.productName} x${i.quantity} ($${i.price})</li>`).join('');
                const itemsHtml = `<ul class="product-list">${itemsList}</ul>`;
                html += `<tr data-order-id="${order.id}">
                    <td>${order.date ? new Date(order.date).toLocaleString() : ''}</td>
                    <td>${customer.name}</td>
                    <td>
                        <span class="badge ${order.status}" data-order-id="${order.id}">${order.status}</span>
                        <div class="status-menu" id="status-menu-${order.id}">
                            <button data-status="pendiente">Pendiente</button>
                            <button data-status="entregado">Entregado</button>
                            <button data-status="incompleto">Incompleto</button>
                        </div>
                    </td>
                    <td>${itemsHtml}</td>
                    <td>${order.comments || ''}</td>
                    <td class="actions-cell">
                        <button class="icon-btn edit-order" data-id="${order.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-order" data-id="${order.id}">üóëÔ∏è</button>
                        ${order.ticketPhoto ? `<button class="icon-btn view-photo" data-photo="${order.ticketPhoto}">üì∑</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            ordersListDiv.innerHTML = html;

            // Eventos (usando delegaci√≥n en lugar de asignar uno por uno, pero mantenemos igual por simplicidad)
            document.querySelectorAll('.edit-order').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openOrderModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-order').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteOrder(btn.dataset.id);
            }));
            document.querySelectorAll('.view-photo').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const photo = btn.dataset.photo;
                    if (photo) {
                        modalImage.src = photo;
                        imageModal.style.display = 'flex';
                    }
                });
            });
            document.querySelectorAll('.badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const orderId = badge.dataset.orderId;
                    const menu = document.getElementById(`status-menu-${orderId}`);
                    document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
                    const rect = badge.getBoundingClientRect();
                    menu.style.top = rect.bottom + window.scrollY + 'px';
                    menu.style.left = rect.left + window.scrollX + 'px';
                    menu.style.display = 'block';
                });
            });
            document.querySelectorAll('.status-menu button').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const menu = btn.closest('.status-menu');
                    const orderId = menu.id.replace('status-menu-', '');
                    const newStatus = btn.dataset.status;
                    await updateOrderStatus(orderId, newStatus);
                    menu.style.display = 'none';
                });
            });
            document.addEventListener('click', () => {
                document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
            });
        }

        // ---- Clientes ----
        function renderCustomers() {
            if (!customersListDiv) return;
            if (customers.length === 0) {
                customersListDiv.innerHTML = '<p class="card">No hay clientes.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Direcci√≥n</th><th>Email</th><th>Acciones</th></tr></thead><tbody>';
            customers.forEach(c => {
                html += `<tr>
                    <td>${c.name}</td>
                    <td>${c.phone || ''}</td>
                    <td>${c.address || ''}</td>
                    <td>${c.email || ''}</td>
                    <td class="actions-cell">
                        <button class="icon-btn edit-customer" data-id="${c.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-customer" data-id="${c.id}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            customersListDiv.innerHTML = html;
            document.querySelectorAll('.edit-customer').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openCustomerModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-customer').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCustomer(btn.dataset.id);
            }));
        }

        // ---- Productos ----
        function renderProductsList() {
            if (!productListDiv) return;
            if (products.length === 0) {
                productListDiv.innerHTML = '<p>No hay productos cargados. Sub√≠ un archivo CSV o Excel.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Nombre</th><th>Precio</th><th>Acciones</th></tr></thead><tbody>';
            products.slice(0, 100).forEach(p => {
                html += `<tr>
                    <td>${p.name}</td>
                    <td>${p.price ? '$' + p.price : '-'}</td>
                    <td class="actions-cell">
                        <button class="icon-btn edit-product" data-id="${p.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-product" data-id="${p.id}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            if (products.length > 100) html += '<tr><td colspan="3">... y ' + (products.length-100) + ' m√°s</td></tr>';
            html += '</tbody></table>';
            productListDiv.innerHTML = html;
            document.querySelectorAll('.edit-product').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openProductModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-product').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteProduct(btn.dataset.id);
            }));
        }

        // ---- Modal Pedido (adaptado) ----
        function openOrderModal(orderId = null) {
            const isEdit = !!orderId;
            modalTitle.innerText = isEdit ? '‚úèÔ∏è Editar Pedido' : '‚ûï Nuevo Pedido';
            orderForm.reset();
            orderIdHidden.value = '';
            productsContainer.innerHTML = '';
            photoPreviewContainer.innerHTML = '';
            updateCustomerSelect();
            if (isEdit) {
                const order = orders.find(o => o.id === orderId);
                if (!order) return;
                orderIdHidden.value = order.id;
                customerSelect.value = order.customerId;
                orderDate.value = order.date;
                orderStatus.value = order.status;
                orderComments.value = order.comments || '';
                order.items.forEach(item => addProductRow(item));
                if (order.ticketPhoto) {
                    const img = document.createElement('img');
                    img.src = order.ticketPhoto;
                    img.className = 'photo-preview';
                    photoPreviewContainer.appendChild(img);
                }
            } else {
                const now = new Date();
                const tzOffset = now.getTimezoneOffset() * 60000;
                const localISOTime = new Date(now - tzOffset).toISOString().slice(0, 16);
                orderDate.value = localISOTime;
                addProductRow();
            }
            orderModal.style.display = 'flex';
        }

        function updateCustomerSelect() {
            customerSelect.innerHTML = '<option value="">Seleccionar cliente</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function addProductRow(item = null) {
            const div = document.createElement('div');
            div.className = 'product-item';
            div.innerHTML = `
                <input type="text" placeholder="Producto" list="productDatalist" value="${item ? item.productName : ''}" class="product-name">
                <input type="number" placeholder="Cant" value="${item ? item.quantity : 1}" min="1" style="width:80px;" class="product-qty">
                <input type="number" placeholder="Precio" value="${item ? item.price : ''}" min="0" step="0.01" style="width:100px;" class="product-price">
                <button type="button" class="remove-product">‚úï</button>
            `;
            div.querySelector('.remove-product').addEventListener('click', () => div.remove());
            productsContainer.appendChild(div);
        }

        cancelOrderBtn.addEventListener('click', () => orderModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === orderModal) orderModal.style.display = 'none';
            if (e.target === quickCustomerModal) quickCustomerModal.style.display = 'none';
            if (e.target === customerModal) customerModal.style.display = 'none';
            if (e.target === imageModal) imageModal.style.display = 'none';
        });

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = customerSelect.value;
            if (!customerId) return alert('Seleccion√° un cliente');
            const items = [];
            document.querySelectorAll('#productsContainer .product-item').forEach(row => {
                const nameInput = row.querySelector('.product-name');
                const qtyInput = row.querySelector('.product-qty');
                const priceInput = row.querySelector('.product-price');
                if (nameInput.value.trim() !== '') {
                    items.push({
                        productId: null,
                        productName: nameInput.value.trim(),
                        quantity: parseInt(qtyInput.value) || 1,
                        price: parseFloat(priceInput.value) || 0
                    });
                }
            });
            if (items.length === 0) return alert('Agreg√° al menos un producto');

            const fileInput = document.getElementById('ticketPhoto');
            const file = fileInput.files[0];

            const orderData = {
                id: orderIdHidden.value || undefined, // si no hay id, Firestore lo genera
                customerId,
                date: orderDate.value,
                status: orderStatus.value,
                comments: orderComments.value,
                items,
                ticketPhoto: '' // se llenar√° despu√©s si hay foto
            };

            await saveOrder(orderData, file);
            orderModal.style.display = 'none';
            // No necesitamos renderOrders porque la suscripci√≥n lo har√°
        });

        ticketPhoto.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    photoPreviewContainer.innerHTML = `<img src="${ev.target.result}" class="photo-preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        addProductBtn.addEventListener('click', () => addProductRow());

        // ---- Cliente r√°pido ----
        quickAddCustomerBtn.addEventListener('click', () => {
            quickCustomerForm.reset();
            quickCustomerModal.style.display = 'flex';
        });

        cancelQuickBtn.addEventListener('click', () => quickCustomerModal.style.display = 'none');

        quickCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCust = {
                name: quickName.value.trim(),
                phone: quickPhone.value.trim(),
                address: quickAddress.value.trim(),
                email: quickEmail.value.trim()
            };
            if (!newCust.name) return alert('El nombre es obligatorio');
            await saveCustomer(newCust);
            // El select se actualizar√° v√≠a suscripci√≥n, pero podemos forzar actualizaci√≥n manual
            updateCustomerSelect();
            customerSelect.value = newCust.id; // Ojo: newCust.id no est√° disponible hasta despu√©s de guardar. Mejor: luego de guardar, obtenemos el id.
            // Simplificamos: despu√©s de guardar, recargamos clientes y seleccionamos el √∫ltimo.
            quickCustomerModal.style.display = 'none';
        });

        // ---- Cliente normal ----
        function openCustomerModal(id = null) {
            customerModalTitle.innerText = id ? '‚úèÔ∏è Editar Cliente' : 'üë§ Nuevo Cliente';
            customerForm.reset();
            customerIdHidden.value = '';
            if (id) {
                const cust = customers.find(c => c.id === id);
                if (cust) {
                    customerIdHidden.value = cust.id;
                    customerName.value = cust.name;
                    customerPhone.value = cust.phone || '';
                    customerAddress.value = cust.address || '';
                    customerEmail.value = cust.email || '';
                }
            }
            customerModal.style.display = 'flex';
        }

        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const custData = {
                id: customerIdHidden.value || undefined,
                name: customerName.value.trim(),
                phone: customerPhone.value.trim(),
                address: customerAddress.value.trim(),
                email: customerEmail.value.trim()
            };
            if (!custData.name) return alert('El nombre es obligatorio');
            await saveCustomer(custData);
            customerModal.style.display = 'none';
        });

        cancelCustomerBtn.addEventListener('click', () => customerModal.style.display = 'none');
        newCustomerBtn.addEventListener('click', () => openCustomerModal());
        newOrderBtn.addEventListener('click', () => openOrderModal());

        // Filtros pedidos (eventos)
        searchOrders.addEventListener('input', renderOrders);
        statusFilter.addEventListener('change', renderOrders);
        dateFrom.addEventListener('change', renderOrders);
        dateTo.addEventListener('change', renderOrders);

        // ---- Productos: carga Excel/CSV (ahora usa importProducts) ----
        function handleProductFile(file) {
            const reader = new FileReader();
            const fileType = file.name.split('.').pop().toLowerCase();
            dropZone.innerHTML = `<span class="spinner"></span> Procesando archivo...`;

            if (fileType === 'csv') {
                reader.onload = (ev) => {
                    try {
                        const newProducts = parseCSV(ev.target.result);
                        importProducts(newProducts).then(() => {
                            resetDropZone('‚úÖ Productos cargados correctamente');
                        }).catch(() => resetDropZone());
                    } catch (err) {
                        alert('Error al leer CSV: ' + err.message);
                        resetDropZone();
                    }
                };
                reader.readAsText(file);
            } else if (fileType === 'xls' || fileType === 'xlsx') {
                reader.onload = (ev) => {
                    try {
                        const data = new Uint8Array(ev.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        if (rows.length < 2) throw new Error('El archivo no tiene datos');
                        const headers = rows[0].map(h => String(h).toLowerCase().trim());
                        const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto' || h === 'productos');
                        const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe') || h === 'costo');
                        if (nameIdx === -1) throw new Error('No se encontr√≥ una columna de "nombre" o "producto"');

                        const newProducts = [];
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row || row.length === 0) continue;
                            const name = row[nameIdx] ? String(row[nameIdx]).trim() : '';
                            if (!name) continue;
                            let price = undefined;
                            if (priceIdx !== -1 && row[priceIdx] !== undefined) {
                                const val = row[priceIdx];
                                if (typeof val === 'number') price = val;
                                else if (typeof val === 'string') {
                                    const num = parseFloat(val.replace(/[^\d.,-]/g, '').replace(',', '.'));
                                    if (!isNaN(num)) price = num;
                                }
                            }
                            newProducts.push({ name, price }); // sin id, se generar√° en Firestore
                        }
                        importProducts(newProducts).then(() => {
                            resetDropZone('‚úÖ Productos cargados correctamente');
                        }).catch(() => resetDropZone());
                    } catch (err) {
                        alert('Error al leer Excel: ' + err.message);
                        resetDropZone();
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Formato no soportado. Us√° CSV o Excel.');
                resetDropZone();
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto');
            const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe'));
            if (nameIdx === -1) throw new Error('El CSV debe tener una columna "nombre" o "producto"');
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length <= nameIdx) continue;
                const name = values[nameIdx];
                if (!name) continue;
                let price = undefined;
                if (priceIdx !== -1 && values[priceIdx]) {
                    const num = parseFloat(values[priceIdx].replace(/[^\d.,-]/g, '').replace(',', '.'));
                    if (!isNaN(num)) price = num;
                }
                result.push({ name, price }); // sin id
            }
            return result;
        }

        function resetDropZone(message = 'üìÇ Arrastr√° o hac√© clic para seleccionar archivo (CSV o Excel)') {
            dropZone.innerHTML = message;
        }

        dropZone.addEventListener('click', () => productFile.click());
        dropZone.addEventListener('dragover', (e) => e.preventDefault());
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) handleProductFile(file);
        });
        productFile.addEventListener('change', (e) => {
            if (e.target.files[0]) handleProductFile(e.target.files[0]);
        });

        clearProductsBtn.addEventListener('click', clearAllProducts);

        // ---- Backup ----
        exportBackupBtn.addEventListener('click', exportBackup);

        importZone.addEventListener('click', () => importFile.click());
        importZone.addEventListener('dragover', (e) => e.preventDefault());
        importZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) importBackup(file);
        });
        importFile.addEventListener('change', (e) => {
            if (e.target.files[0]) importBackup(e.target.files[0]);
        });

        // ---- Datalist de productos ----
        const datalist = document.createElement('datalist');
        datalist.id = 'productDatalist';
        document.body.appendChild(datalist);
        function updateProductDatalist() {
            datalist.innerHTML = products.map(p => `<option value="${p.name}">${p.price ? '$'+p.price : ''}</option>`).join('');
        }

        // ---- Cerrar modal de imagen ----
        document.querySelector('#imageModal .close').addEventListener('click', () => imageModal.style.display = 'none');

        // ---- Inicializar: cargar datos y luego iniciar suscripciones ----
        loadAllData().then(() => {
            startSubscriptions();
            setActiveView('orders');
        });
    })();
</script>
</body>
</html>
