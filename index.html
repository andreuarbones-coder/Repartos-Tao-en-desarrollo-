<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminRepartos Pro</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        /* (Estilos mejorados - mismos que antes pero con algunos retoques) */
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
        body { background: #f4f6f9; padding: 1rem; min-height: 100vh; display: flex; justify-content: center; }
        #app { max-width: 1400px; width: 100%; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: #1e2b3a; color: white; padding: 1rem 2rem; display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem; }
        header h1 { font-size: 1.8rem; font-weight: 400; margin-right: auto; }
        .nav-btn { background: transparent; border: none; color: #ccc; font-size: 1rem; padding: 0.5rem 1rem; cursor: pointer; border-radius: 30px; transition: 0.2s; }
        .nav-btn:hover { background: #2c3e50; color: white; }
        .nav-btn.active { background: #3b4e62; color: white; font-weight: 500; }
        main { padding: 2rem; }
        .views-container > div { display: none; }
        .views-container > div.active-view { display: block; }
        h2 { margin-bottom: 1.5rem; color: #1e2b3a; font-weight: 400; border-bottom: 2px solid #eaeef2; padding-bottom: 0.5rem; }
        button, .btn { background: #1e2b3a; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 30px; font-size: 0.95rem; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        button:hover { background: #2c3e50; }
        button.secondary { background: white; color: #1e2b3a; border: 1px solid #1e2b3a; }
        button.secondary:hover { background: #f0f3f7; }
        .card { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eaeef2; margin-bottom: 2rem; }
        .flex-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
        .search-box { flex: 1; min-width: 250px; padding: 0.7rem 1rem; border-radius: 30px; border: 1px solid #d0d9e2; font-size: 1rem; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .filter-group input, .filter-group select { padding: 0.5rem 1rem; border-radius: 30px; border: 1px solid #d0d9e2; font-size: 0.95rem; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eaeef2; vertical-align: top; }
        th { background: #f8fafc; font-weight: 500; color: #2c3e50; }
        tr:hover { background: #f9fcff; }
        .badge { display: inline-block; padding: 0.25rem 0.8rem; border-radius: 30px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .badge.pendiente { background: #fff3cd; color: #856404; }
        .badge.entregado { background: #d4edda; color: #155724; }
        .badge.incompleto { background: #f8d7da; color: #721c24; }
        .badge:hover { filter: brightness(0.95); }
        .actions-cell { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .icon-btn { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.2rem 0.5rem; border-radius: 8px; line-height: 1; }
        .icon-btn:hover { background: #e9ecef; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 500; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem 1rem; border-radius: 30px; border: 1px solid #d0d9e2; font-size: 1rem; }
        .form-group textarea { border-radius: 16px; resize: vertical; min-height: 80px; }
        .photo-preview { max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid #ccc; margin-top: 0.5rem; }
        .product-item { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .product-item input { flex: 1; }
        .remove-product { background: #f8d7da; color: #721c24; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .file-upload { border: 2px dashed #b8c5d0; border-radius: 30px; padding: 1.5rem; text-align: center; background: #fcfdff; cursor: pointer; }
        .file-upload:hover { background: #f2f6fa; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #1e2b3a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-menu { position: absolute; background: white; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 0.5rem; z-index: 100; display: none; }
        .status-menu button { display: block; width: 100%; background: white; border: none; padding: 0.5rem 1rem; text-align: left; border-radius: 30px; margin: 2px 0; color: #1e2b3a; }
        .status-menu button:hover { background: #f0f3f7; }
        .image-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .image-modal .close { position: absolute; top: 20px; right: 30px; font-size: 2rem; color: white; cursor: pointer; }
        .inline-add { display: flex; gap: 0.5rem; align-items: center; }
        .inline-add select { flex: 1; }
        .inline-add button { width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; padding: 0; }
        .product-list { list-style: disc; padding-left: 1.2rem; margin: 0; }
        .product-list li { margin-bottom: 0.2rem; }
        .date-filter { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .date-filter input { padding: 0.5rem; border-radius: 30px; border: 1px solid #d0d9e2; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast { background: #1e2b3a; color: white; padding: 0.8rem 1.5rem; border-radius: 30px; margin-top: 0.5rem; box-shadow: 0 3px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s; }
        .toast.error { background: #dc3545; }
        .toast.success { background: #28a745; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .pagination { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
        .pagination button { background: white; color: #1e2b3a; border: 1px solid #d0d9e2; padding: 0.3rem 0.8rem; }
        .pagination button.active { background: #1e2b3a; color: white; }
    </style>
</head>
<body>
<div id="app"></div>

<!-- Templates para modales (se inyectan con JS) -->
<script type="module">
    // --- M√≥dulo de almacenamiento ---
    class Store {
        static KEYS = {
            CUSTOMERS: 'repartos_customers',
            PRODUCTS: 'repartos_products',
            ORDERS: 'repartos_orders'
        };

        static load() {
            try {
                return {
                    customers: JSON.parse(localStorage.getItem(this.KEYS.CUSTOMERS)) || [],
                    products: JSON.parse(localStorage.getItem(this.KEYS.PRODUCTS)) || [],
                    orders: JSON.parse(localStorage.getItem(this.KEYS.ORDERS)) || []
                };
            } catch {
                return { customers: [], products: [], orders: [] };
            }
        }

        static save(data) {
            localStorage.setItem(this.KEYS.CUSTOMERS, JSON.stringify(data.customers));
            localStorage.setItem(this.KEYS.PRODUCTS, JSON.stringify(data.products));
            localStorage.setItem(this.KEYS.ORDERS, JSON.stringify(data.orders));
        }
    }

    // --- M√≥dulo de notificaciones ---
    class Toast {
        constructor() {
            this.container = document.createElement('div');
            this.container.className = 'toast-container';
            document.body.appendChild(this.container);
        }
        show(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            this.container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    }

    // --- M√≥dulo de utilidades ---
    const Utils = {
        generateId: () => Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        formatDate: (iso) => iso ? new Date(iso).toLocaleString() : '',
        compressImage: (file, maxSizeKB = 500) => {
            return new Promise((resolve) => {
                if (!file) return resolve('');
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        // Reducir tama√±o si es muy grande
                        const maxDimension = 1024;
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = (height / width) * maxDimension;
                                width = maxDimension;
                            } else {
                                width = (width / height) * maxDimension;
                                height = maxDimension;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Comprimir calidad hasta que sea menor a maxSizeKB
                        let quality = 0.9;
                        let compressed = canvas.toDataURL('image/jpeg', quality);
                        while (compressed.length > maxSizeKB * 1024 && quality > 0.1) {
                            quality -= 0.1;
                            compressed = canvas.toDataURL('image/jpeg', quality);
                        }
                        resolve(compressed);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        },
        debounce: (fn, delay) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }
    };

    // --- Clase principal App ---
    class App {
        constructor() {
            this.data = Store.load();
            this.toast = new Toast();
            this.currentView = 'orders';
            this.filters = {
                orders: { search: '', status: 'todos', from: '', to: '' },
                customers: { search: '' },
                products: { search: '' }
            };
            this.pagination = {
                orders: { page: 1, pageSize: 20 },
                customers: { page: 1, pageSize: 20 },
                products: { page: 1, pageSize: 20 }
            };
            this.initDOM();
            this.attachEvents();
            this.render();
        }

        initDOM() {
            // Estructura base
            document.getElementById('app').innerHTML = `
                <header>
                    <h1>üì¶ AdminRepartos Pro</h1>
                    <button class="nav-btn" data-view="orders">üìã Pedidos</button>
                    <button class="nav-btn" data-view="customers">üë• Clientes</button>
                    <button class="nav-btn" data-view="products">üì¶ Productos</button>
                    <button class="nav-btn" data-view="backup">üíæ Backup</button>
                </header>
                <main>
                    <div class="views-container" id="viewsContainer"></div>
                </main>
            `;
            this.viewsContainer = document.getElementById('viewsContainer');
            this.renderViews();
        }

        renderViews() {
            this.viewsContainer.innerHTML = `
                <div id="view-orders" class="active-view"></div>
                <div id="view-customers"></div>
                <div id="view-products"></div>
                <div id="view-backup"></div>
            `;
        }

        attachEvents() {
            // Navegaci√≥n
            document.querySelectorAll('.nav-btn').forEach(btn =>
                btn.addEventListener('click', () => this.setView(btn.dataset.view))
            );

            // Delegaci√≥n de eventos global
            document.addEventListener('click', (e) => {
                const target = e.target;
                // Botones dentro de tablas
                if (target.matches('.edit-order')) this.openOrderModal(target.dataset.id);
                if (target.matches('.delete-order')) this.deleteOrder(target.dataset.id);
                if (target.matches('.view-photo')) this.showImage(target.dataset.photo);
                if (target.matches('.edit-customer')) this.openCustomerModal(target.dataset.id);
                if (target.matches('.delete-customer')) this.deleteCustomer(target.dataset.id);
                if (target.matches('.edit-product')) this.openProductModal(target.dataset.id);
                if (target.matches('.delete-product')) this.deleteProduct(target.dataset.id);
                if (target.matches('.badge')) this.showStatusMenu(target);
                if (target.matches('.status-menu button')) this.changeStatus(target);
                if (target.matches('.pagination button')) this.changePage(target);
            });

            // Cerrar men√∫s al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!e.target.matches('.badge') && !e.target.closest('.status-menu')) {
                    document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
                }
            });

            // Filtros (debounced)
            const handleSearch = Utils.debounce((view, value) => {
                this.filters[view].search = value;
                this.pagination[view].page = 1;
                this.renderView(view);
            }, 300);

            // Delegaci√≥n para inputs de filtro
            document.addEventListener('input', (e) => {
                if (e.target.matches('#searchOrders')) handleSearch('orders', e.target.value);
                if (e.target.matches('#searchCustomers')) handleSearch('customers', e.target.value);
                if (e.target.matches('#searchProducts')) handleSearch('products', e.target.value);
                if (e.target.matches('#statusFilter')) {
                    this.filters.orders.status = e.target.value;
                    this.renderView('orders');
                }
                if (e.target.matches('#dateFrom') || e.target.matches('#dateTo')) {
                    this.filters.orders.from = document.getElementById('dateFrom')?.value || '';
                    this.filters.orders.to = document.getElementById('dateTo')?.value || '';
                    this.renderView('orders');
                }
            });

            // Modales
            document.getElementById('newOrderBtn')?.addEventListener('click', () => this.openOrderModal());
            document.getElementById('newCustomerBtn')?.addEventListener('click', () => this.openCustomerModal());
            document.getElementById('newProductBtn')?.addEventListener('click', () => this.openProductModal());
            document.getElementById('cancelOrderBtn')?.addEventListener('click', () => this.closeModal('orderModal'));
            document.getElementById('cancelCustomerBtn')?.addEventListener('click', () => this.closeModal('customerModal'));
            document.getElementById('cancelProductBtn')?.addEventListener('click', () => this.closeModal('productModal'));
            document.getElementById('quickAddCustomerBtn')?.addEventListener('click', () => this.openQuickCustomerModal());
            document.getElementById('cancelQuickBtn')?.addEventListener('click', () => this.closeModal('quickCustomerModal'));
            document.getElementById('addProductBtn')?.addEventListener('click', () => this.addProductRow());

            // Formularios
            document.getElementById('orderForm')?.addEventListener('submit', (e) => this.saveOrder(e));
            document.getElementById('customerForm')?.addEventListener('submit', (e) => this.saveCustomer(e));
            document.getElementById('productForm')?.addEventListener('submit', (e) => this.saveProduct(e));
            document.getElementById('quickCustomerForm')?.addEventListener('submit', (e) => this.saveQuickCustomer(e));

            // Archivos
            document.getElementById('productFile')?.addEventListener('change', (e) => this.handleProductFile(e.target.files[0]));
            document.getElementById('importFile')?.addEventListener('change', (e) => this.handleImport(e.target.files[0]));
            document.getElementById('dropZone')?.addEventListener('click', () => document.getElementById('productFile').click());
            document.getElementById('importZone')?.addEventListener('click', () => document.getElementById('importFile').click());
            document.getElementById('dropZone')?.addEventListener('dragover', (e) => e.preventDefault());
            document.getElementById('dropZone')?.addEventListener('drop', (e) => {
                e.preventDefault();
                this.handleProductFile(e.dataTransfer.files[0]);
            });
            document.getElementById('importZone')?.addEventListener('dragover', (e) => e.preventDefault());
            document.getElementById('importZone')?.addEventListener('drop', (e) => {
                e.preventDefault();
                this.handleImport(e.dataTransfer.files[0]);
            });

            document.getElementById('clearProducts')?.addEventListener('click', () => this.clearProducts());
            document.getElementById('exportBackup')?.addEventListener('click', () => this.exportBackup());

            // Foto ticket
            document.getElementById('ticketPhoto')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const compressed = await Utils.compressImage(file);
                    document.getElementById('photoPreviewContainer').innerHTML = `<img src="${compressed}" class="photo-preview">`;
                }
            });

            // Cerrar modales con tecla Escape
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                }
            });
        }

        setView(view) {
            this.currentView = view;
            document.querySelectorAll('.views-container > div').forEach(div => div.classList.remove('active-view'));
            document.getElementById(`view-${view}`).classList.add('active-view');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-view="${view}"]`).classList.add('active');
            this.renderView(view);
        }

        renderView(view) {
            if (view === 'orders') this.renderOrders();
            if (view === 'customers') this.renderCustomers();
            if (view === 'products') this.renderProducts();
            if (view === 'backup') this.renderBackup();
        }

        render() {
            this.renderView(this.currentView);
        }

        // --- VISTA PEDIDOS ---
        renderOrders() {
            const container = document.getElementById('view-orders');
            const filter = this.filters.orders;
            const pag = this.pagination.orders;

            let filtered = this.data.orders.filter(order => {
                if (filter.status !== 'todos' && order.status !== filter.status) return false;
                const orderDate = order.date?.split('T')[0] || '';
                if (filter.from && orderDate < filter.from) return false;
                if (filter.to && orderDate > filter.to) return false;
                if (filter.search) {
                    const customer = this.data.customers.find(c => c.id === order.customerId) || {};
                    const text = (customer.name + ' ' + (customer.phone || '') + ' ' + (customer.address || '') + ' ' + (order.comments || '') + ' ' + order.items.map(i => i.productName).join(' ')).toLowerCase();
                    return text.includes(filter.search.toLowerCase());
                }
                return true;
            });

            const totalPages = Math.ceil(filtered.length / pag.pageSize);
            const start = (pag.page - 1) * pag.pageSize;
            const pageItems = filtered.slice(start, start + pag.pageSize);

            let html = `
                <div class="flex-row">
                    <h2>üìã Lista de Pedidos</h2>
                    <button id="newOrderBtn" class="secondary">‚ûï Nuevo pedido</button>
                </div>
                <div class="flex-row">
                    <input type="text" id="searchOrders" class="search-box" placeholder="üîç Buscar..." value="${filter.search}">
                    <div class="filter-group">
                        <select id="statusFilter">
                            <option value="todos" ${filter.status === 'todos' ? 'selected' : ''}>Todos</option>
                            <option value="pendiente" ${filter.status === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="entregado" ${filter.status === 'entregado' ? 'selected' : ''}>Entregado</option>
                            <option value="incompleto" ${filter.status === 'incompleto' ? 'selected' : ''}>Incompleto</option>
                        </select>
                        <div class="date-filter">
                            <input type="date" id="dateFrom" value="${filter.from}">
                            <input type="date" id="dateTo" value="${filter.to}">
                        </div>
                    </div>
                </div>
            `;

            if (pageItems.length === 0) {
                html += '<p class="card">No hay pedidos.</p>';
            } else {
                html += '<table><thead><tr><th>Fecha</th><th>Cliente</th><th>Estado</th><th>Productos</th><th>Comentarios</th><th>Acciones</th></tr></thead><tbody>';
                pageItems.forEach(order => {
                    const customer = this.data.customers.find(c => c.id === order.customerId) || { name: '?' };
                    const itemsList = order.items.map(i => `<li>${i.productName} x${i.quantity} ($${i.price})</li>`).join('');
                    html += `<tr data-order-id="${order.id}">
                        <td>${Utils.formatDate(order.date)}</td>
                        <td>${customer.name}</td>
                        <td>
                            <span class="badge ${order.status}" data-order-id="${order.id}">${order.status}</span>
                            <div class="status-menu" id="status-menu-${order.id}">
                                <button data-status="pendiente">Pendiente</button>
                                <button data-status="entregado">Entregado</button>
                                <button data-status="incompleto">Incompleto</button>
                            </div>
                        </td>
                        <td><ul class="product-list">${itemsList}</ul></td>
                        <td>${order.comments || ''}</td>
                        <td class="actions-cell">
                            <button class="icon-btn edit-order" data-id="${order.id}">‚úèÔ∏è</button>
                            <button class="icon-btn delete-order" data-id="${order.id}">üóëÔ∏è</button>
                            ${order.ticketPhoto ? `<button class="icon-btn view-photo" data-photo="${order.ticketPhoto}">üì∑</button>` : ''}
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += this.renderPagination('orders', totalPages, pag.page);
            }
            container.innerHTML = html;
        }

        // --- VISTA CLIENTES ---
        renderCustomers() {
            const container = document.getElementById('view-customers');
            const filter = this.filters.customers;
            const pag = this.pagination.customers;

            let filtered = this.data.customers.filter(c => {
                if (!filter.search) return true;
                const text = (c.name + ' ' + (c.phone || '') + ' ' + (c.address || '') + ' ' + (c.email || '')).toLowerCase();
                return text.includes(filter.search.toLowerCase());
            });

            const totalPages = Math.ceil(filtered.length / pag.pageSize);
            const start = (pag.page - 1) * pag.pageSize;
            const pageItems = filtered.slice(start, start + pag.pageSize);

            let html = `
                <div class="flex-row">
                    <h2>üë• Clientes</h2>
                    <button id="newCustomerBtn" class="secondary">‚ûï Nuevo cliente</button>
                </div>
                <div class="flex-row">
                    <input type="text" id="searchCustomers" class="search-box" placeholder="üîç Buscar cliente..." value="${filter.search}">
                </div>
            `;

            if (pageItems.length === 0) {
                html += '<p class="card">No hay clientes.</p>';
            } else {
                html += '<table><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Direcci√≥n</th><th>Email</th><th>Acciones</th></tr></thead><tbody>';
                pageItems.forEach(c => {
                    html += `<tr>
                        <td>${c.name}</td>
                        <td>${c.phone || ''}</td>
                        <td>${c.address || ''}</td>
                        <td>${c.email || ''}</td>
                        <td class="actions-cell">
                            <button class="icon-btn edit-customer" data-id="${c.id}">‚úèÔ∏è</button>
                            <button class="icon-btn delete-customer" data-id="${c.id}">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += this.renderPagination('customers', totalPages, pag.page);
            }
            container.innerHTML = html;
        }

        // --- VISTA PRODUCTOS ---
        renderProducts() {
            const container = document.getElementById('view-products');
            const filter = this.filters.products;
            const pag = this.pagination.products;

            let filtered = this.data.products.filter(p => {
                if (!filter.search) return true;
                return p.name.toLowerCase().includes(filter.search.toLowerCase());
            });

            const totalPages = Math.ceil(filtered.length / pag.pageSize);
            const start = (pag.page - 1) * pag.pageSize;
            const pageItems = filtered.slice(start, start + pag.pageSize);

            let html = `
                <div class="flex-row">
                    <h2>üì¶ Productos</h2>
                    <button id="newProductBtn" class="secondary">‚ûï Nuevo producto</button>
                </div>
                <div class="flex-row">
                    <input type="text" id="searchProducts" class="search-box" placeholder="üîç Buscar producto..." value="${filter.search}">
                </div>
                <div class="card">
                    <p style="margin-bottom:1rem">Sub√≠ un archivo CSV o Excel para cargar productos.</p>
                    <div class="file-upload" id="dropZone">
                        üìÇ Arrastr√° o hac√© clic para seleccionar archivo
                        <input type="file" id="productFile" accept=".csv, .xls, .xlsx" style="display: none;">
                    </div>
                    <div style="margin-top:1rem">
                        <button id="clearProducts" class="secondary">üóëÔ∏è Limpiar todos</button>
                    </div>
                </div>
            `;

            if (pageItems.length === 0) {
                html += '<p class="card">No hay productos cargados.</p>';
            } else {
                html += '<table><thead><tr><th>Nombre</th><th>Precio</th><th>Acciones</th></tr></thead><tbody>';
                pageItems.forEach(p => {
                    html += `<tr>
                        <td>${p.name}</td>
                        <td>${p.price ? '$' + p.price : '-'}</td>
                        <td class="actions-cell">
                            <button class="icon-btn edit-product" data-id="${p.id}">‚úèÔ∏è</button>
                            <button class="icon-btn delete-product" data-id="${p.id}">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                html += this.renderPagination('products', totalPages, pag.page);
            }
            container.innerHTML = html;
            this.updateProductDatalist();
        }

        renderBackup() {
            document.getElementById('view-backup').innerHTML = `
                <h2>üíæ Respaldos</h2>
                <div class="card">
                    <button id="exportBackup" style="width:100%; margin-bottom:1rem">üì• Exportar datos (backup.json)</button>
                    <div class="file-upload" id="importZone">
                        üìÇ Arrastr√° o hac√© clic para restaurar backup (JSON)
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>
                </div>
            `;
        }

        renderPagination(view, totalPages, currentPage) {
            if (totalPages <= 1) return '';
            let html = '<div class="pagination">';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" data-view="${view}" data-page="${i}">${i}</button>`;
            }
            html += '</div>';
            return html;
        }

        changePage(btn) {
            const view = btn.dataset.view;
            const page = parseInt(btn.dataset.page);
            if (this.pagination[view]) {
                this.pagination[view].page = page;
                this.renderView(view);
            }
        }

        // --- MODALES ---
        openOrderModal(id = null) {
            const modal = this.createModal('orderModal', `
                <h3 id="modalTitle">${id ? '‚úèÔ∏è Editar Pedido' : '‚ûï Nuevo Pedido'}</h3>
                <form id="orderForm">
                    <input type="hidden" id="orderId" value="${id || ''}">
                    <div class="form-grid">
                        <div>
                            <div class="form-group">
                                <label>Cliente</label>
                                <div class="inline-add">
                                    <select id="customerSelect" required></select>
                                    <button type="button" id="quickAddCustomerBtn" class="secondary">‚ûï</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="datetime-local" id="orderDate" required>
                            </div>
                            <div class="form-group">
                                <label>Estado</label>
                                <select id="orderStatus">
                                    <option value="pendiente">Pendiente</option>
                                    <option value="entregado">Entregado</option>
                                    <option value="incompleto">Incompleto</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label>Comentarios</label>
                                <textarea id="orderComments" placeholder="Notas del pedido..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Foto del ticket</label>
                                <input type="file" id="ticketPhoto" accept="image/*">
                                <div id="photoPreviewContainer"></div>
                            </div>
                        </div>
                    </div>
                    <fieldset style="border:1px solid #eaeef2; border-radius:20px; padding:1rem; margin:1rem 0;">
                        <legend>üì¶ Productos en el pedido</legend>
                        <div id="productsContainer"></div>
                        <button type="button" id="addProductBtn" class="secondary" style="margin-top:0.5rem">‚ûï Agregar producto</button>
                    </fieldset>
                    <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:2rem;">
                        <button type="button" id="cancelOrderBtn" class="secondary">Cancelar</button>
                        <button type="submit" id="saveOrderBtn">Guardar pedido</button>
                    </div>
                </form>
            `);

            this.updateCustomerSelect();
            if (id) {
                const order = this.data.orders.find(o => o.id === id);
                if (order) {
                    document.getElementById('orderId').value = order.id;
                    document.getElementById('customerSelect').value = order.customerId;
                    document.getElementById('orderDate').value = order.date;
                    document.getElementById('orderStatus').value = order.status;
                    document.getElementById('orderComments').value = order.comments || '';
                    order.items.forEach(item => this.addProductRow(item));
                    if (order.ticketPhoto) {
                        document.getElementById('photoPreviewContainer').innerHTML = `<img src="${order.ticketPhoto}" class="photo-preview">`;
                    }
                }
            } else {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('orderDate').value = now.toISOString().slice(0, 16);
                this.addProductRow();
            }
            modal.style.display = 'flex';
        }

        openCustomerModal(id = null) {
            const modal = this.createModal('customerModal', `
                <h3 id="customerModalTitle">${id ? '‚úèÔ∏è Editar Cliente' : 'üë§ Nuevo Cliente'}</h3>
                <form id="customerForm">
                    <input type="hidden" id="customerId" value="${id || ''}">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="text" id="customerPhone">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="customerAddress">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="customerEmail">
                    </div>
                    <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:2rem;">
                        <button type="button" id="cancelCustomerBtn" class="secondary">Cancelar</button>
                        <button type="submit" id="saveCustomerBtn">Guardar</button>
                    </div>
                </form>
            `);

            if (id) {
                const cust = this.data.customers.find(c => c.id === id);
                if (cust) {
                    document.getElementById('customerId').value = cust.id;
                    document.getElementById('customerName').value = cust.name;
                    document.getElementById('customerPhone').value = cust.phone || '';
                    document.getElementById('customerAddress').value = cust.address || '';
                    document.getElementById('customerEmail').value = cust.email || '';
                }
            }
        }

        openProductModal(id = null) {
            const modal = this.createModal('productModal', `
                <h3>${id ? '‚úèÔ∏è Editar Producto' : '‚ûï Nuevo Producto'}</h3>
                <form id="productForm">
                    <input type="hidden" id="productId" value="${id || ''}">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>Precio</label>
                        <input type="number" id="productPrice" min="0" step="0.01">
                    </div>
                    <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:2rem;">
                        <button type="button" id="cancelProductBtn" class="secondary">Cancelar</button>
                        <button type="submit" id="saveProductBtn">Guardar</button>
                    </div>
                </form>
            `);

            if (id) {
                const prod = this.data.products.find(p => p.id === id);
                if (prod) {
                    document.getElementById('productId').value = prod.id;
                    document.getElementById('productName').value = prod.name;
                    document.getElementById('productPrice').value = prod.price || '';
                }
            }
        }

        openQuickCustomerModal() {
            const modal = this.createModal('quickCustomerModal', `
                <h3>‚ûï Cliente R√°pido</h3>
                <form id="quickCustomerForm">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="quickName" required>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="text" id="quickPhone">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="quickAddress">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="quickEmail">
                    </div>
                    <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:1.5rem;">
                        <button type="button" id="cancelQuickBtn" class="secondary">Cancelar</button>
                        <button type="submit" id="saveQuickBtn">Guardar y usar</button>
                    </div>
                </form>
            `);
        }

        createModal(id, content) {
            let modal = document.getElementById(id);
            if (modal) modal.remove();
            modal = document.createElement('div');
            modal.id = id;
            modal.className = 'modal';
            modal.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;';
            modal.innerHTML = `<div style="background:white; border-radius:30px; width:90%; max-width:800px; max-height:90vh; overflow:auto; padding:2rem;">${content}</div>`;
            document.body.appendChild(modal);
            return modal;
        }

        closeModal(id) {
            document.getElementById(id)?.remove();
        }

        // --- CRUD OPERATIONS ---
        async saveOrder(e) {
            e.preventDefault();
            const customerId = document.getElementById('customerSelect').value;
            if (!customerId) return this.toast.show('Seleccion√° un cliente', 'error');

            const items = [];
            document.querySelectorAll('#productsContainer .product-item').forEach(row => {
                const name = row.querySelector('.product-name')?.value.trim();
                const qty = parseInt(row.querySelector('.product-qty')?.value) || 1;
                const price = parseFloat(row.querySelector('.product-price')?.value) || 0;
                if (name) items.push({ productId: null, productName: name, quantity: qty, price });
            });
            if (items.length === 0) return this.toast.show('Agreg√° al menos un producto', 'error');

            const photoPreview = document.querySelector('#photoPreviewContainer img');
            const ticketPhoto = photoPreview ? photoPreview.src : '';

            const orderData = {
                id: document.getElementById('orderId').value || Utils.generateId(),
                customerId,
                date: document.getElementById('orderDate').value,
                status: document.getElementById('orderStatus').value,
                comments: document.getElementById('orderComments').value,
                items,
                ticketPhoto
            };

            if (this.data.orders.some(o => o.id === orderData.id)) {
                this.data.orders = this.data.orders.map(o => o.id === orderData.id ? orderData : o);
            } else {
                this.data.orders.push(orderData);
            }

            Store.save(this.data);
            this.closeModal('orderModal');
            this.renderView('orders');
            this.toast.show('Pedido guardado', 'success');
        }

        saveCustomer(e) {
            e.preventDefault();
            const custData = {
                id: document.getElementById('customerId').value || Utils.generateId(),
                name: document.getElementById('customerName').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                address: document.getElementById('customerAddress').value.trim(),
                email: document.getElementById('customerEmail').value.trim()
            };
            if (!custData.name) return this.toast.show('El nombre es obligatorio', 'error');

            if (this.data.customers.some(c => c.id === custData.id)) {
                this.data.customers = this.data.customers.map(c => c.id === custData.id ? custData : c);
            } else {
                this.data.customers.push(custData);
            }

            Store.save(this.data);
            this.closeModal('customerModal');
            this.renderView('customers');
            this.toast.show('Cliente guardado', 'success');
        }

        saveProduct(e) {
            e.preventDefault();
            const prodData = {
                id: document.getElementById('productId').value || Utils.generateId(),
                name: document.getElementById('productName').value.trim(),
                price: parseFloat(document.getElementById('productPrice').value) || undefined
            };
            if (!prodData.name) return this.toast.show('El nombre es obligatorio', 'error');

            if (this.data.products.some(p => p.id === prodData.id)) {
                this.data.products = this.data.products.map(p => p.id === prodData.id ? prodData : p);
            } else {
                this.data.products.push(prodData);
            }

            Store.save(this.data);
            this.closeModal('productModal');
            this.renderView('products');
            this.updateProductDatalist();
            this.toast.show('Producto guardado', 'success');
        }

        saveQuickCustomer(e) {
            e.preventDefault();
            const newCust = {
                id: Utils.generateId(),
                name: document.getElementById('quickName').value.trim(),
                phone: document.getElementById('quickPhone').value.trim(),
                address: document.getElementById('quickAddress').value.trim(),
                email: document.getElementById('quickEmail').value.trim()
            };
            if (!newCust.name) return this.toast.show('El nombre es obligatorio', 'error');
            this.data.customers.push(newCust);
            Store.save(this.data);
            this.updateCustomerSelect();
            document.getElementById('customerSelect').value = newCust.id;
            this.closeModal('quickCustomerModal');
            this.toast.show('Cliente r√°pido agregado', 'success');
        }

        deleteOrder(id) {
            if (confirm('¬øEliminar pedido?')) {
                this.data.orders = this.data.orders.filter(o => o.id !== id);
                Store.save(this.data);
                this.renderView('orders');
                this.toast.show('Pedido eliminado', 'success');
            }
        }

        deleteCustomer(id) {
            if (this.data.orders.some(o => o.customerId === id)) {
                return this.toast.show('No se puede eliminar un cliente con pedidos', 'error');
            }
            if (confirm('¬øEliminar cliente?')) {
                this.data.customers = this.data.customers.filter(c => c.id !== id);
                Store.save(this.data);
                this.renderView('customers');
                this.toast.show('Cliente eliminado', 'success');
            }
        }

        deleteProduct(id) {
            if (confirm('¬øEliminar producto?')) {
                this.data.products = this.data.products.filter(p => p.id !== id);
                Store.save(this.data);
                this.renderView('products');
                this.updateProductDatalist();
                this.toast.show('Producto eliminado', 'success');
            }
        }

        clearProducts() {
            if (confirm('¬øEliminar todos los productos?')) {
                this.data.products = [];
                Store.save(this.data);
                this.renderView('products');
                this.updateProductDatalist();
                this.toast.show('Productos eliminados', 'success');
            }
        }

        // --- UTILS ---
        updateCustomerSelect() {
            const select = document.getElementById('customerSelect');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar cliente</option>' +
                    this.data.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        updateProductDatalist() {
            let datalist = document.getElementById('productDatalist');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'productDatalist';
                document.body.appendChild(datalist);
            }
            datalist.innerHTML = this.data.products.map(p => `<option value="${p.name}" data-price="${p.price || ''}">`).join('');
        }

        addProductRow(item = null) {
            const container = document.getElementById('productsContainer');
            const div = document.createElement('div');
            div.className = 'product-item';
            div.innerHTML = `
                <input type="text" placeholder="Producto" list="productDatalist" value="${item ? item.productName : ''}" class="product-name">
                <input type="number" placeholder="Cant" value="${item ? item.quantity : 1}" min="1" style="width:80px;" class="product-qty">
                <input type="number" placeholder="Precio" value="${item ? item.price : ''}" min="0" step="0.01" style="width:100px;" class="product-price">
                <button type="button" class="remove-product">‚úï</button>
            `;
            div.querySelector('.remove-product').addEventListener('click', () => div.remove());
            container.appendChild(div);
        }

        showImage(src) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `<span class="close">&times;</span><img src="${src}" alt="Foto">`;
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        showStatusMenu(badge) {
            const orderId = badge.dataset.orderId;
            const menu = document.getElementById(`status-menu-${orderId}`);
            if (!menu) return;
            document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
            const rect = badge.getBoundingClientRect();
            menu.style.top = rect.bottom + window.scrollY + 'px';
            menu.style.left = rect.left + window.scrollX + 'px';
            menu.style.display = 'block';
        }

        changeStatus(btn) {
            const menu = btn.closest('.status-menu');
            const orderId = menu.id.replace('status-menu-', '');
            const newStatus = btn.dataset.status;
            const order = this.data.orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                Store.save(this.data);
                this.renderView('orders');
                this.toast.show('Estado actualizado', 'success');
            }
            menu.style.display = 'none';
        }

        // --- IMPORT/EXPORT ---
        async handleProductFile(file) {
            if (!file) return;
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = `<span class="spinner"></span> Procesando...`;

            try {
                const ext = file.name.split('.').pop().toLowerCase();
                let newProducts = [];

                if (ext === 'csv') {
                    const text = await file.text();
                    newProducts = this.parseCSV(text);
                } else if (['xls', 'xlsx'].includes(ext)) {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    newProducts = this.parseExcel(rows);
                } else {
                    throw new Error('Formato no soportado');
                }

                this.data.products = newProducts;
                Store.save(this.data);
                this.renderView('products');
                this.updateProductDatalist();
                dropZone.innerHTML = '‚úÖ Productos cargados correctamente';
                setTimeout(() => dropZone.innerHTML = 'üìÇ Arrastr√° o hac√© clic para seleccionar archivo', 2000);
            } catch (err) {
                dropZone.innerHTML = '‚ùå Error: ' + err.message;
                setTimeout(() => dropZone.innerHTML = 'üìÇ Arrastr√° o hac√© clic para seleccionar archivo', 3000);
            }
        }

        parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto');
            const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe'));
            if (nameIdx === -1) throw new Error('Columna "nombre" no encontrada');

            const products = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const name = values[nameIdx];
                if (!name) continue;
                let price = undefined;
                if (priceIdx !== -1 && values[priceIdx]) {
                    const num = parseFloat(values[priceIdx].replace(/[^\d.,-]/g, '').replace(',', '.'));
                    if (!isNaN(num)) price = num;
                }
                products.push({ id: Utils.generateId(), name, price });
            }
            return products;
        }

        parseExcel(rows) {
            if (rows.length < 2) return [];
            const headers = rows[0].map(h => String(h).toLowerCase().trim());
            const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto');
            const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe'));
            if (nameIdx === -1) throw new Error('Columna "nombre" no encontrada');

            const products = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0) continue;
                const name = row[nameIdx] ? String(row[nameIdx]).trim() : '';
                if (!name) continue;
                let price = undefined;
                if (priceIdx !== -1 && row[priceIdx] !== undefined) {
                    const val = row[priceIdx];
                    if (typeof val === 'number') price = val;
                    else if (typeof val === 'string') {
                        const num = parseFloat(val.replace(/[^\d.,-]/g, '').replace(',', '.'));
                        if (!isNaN(num)) price = num;
                    }
                }
                products.push({ id: Utils.generateId(), name, price });
            }
            return products;
        }

        async handleImport(file) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                if (data.customers) this.data.customers = data.customers;
                if (data.products) this.data.products = data.products;
                if (data.orders) this.data.orders = data.orders;
                Store.save(this.data);
                this.renderView(this.currentView);
                this.toast.show('Restauraci√≥n exitosa', 'success');
            } catch {
                this.toast.show('Archivo inv√°lido', 'error');
            }
        }

        exportBackup() {
            const dataStr = JSON.stringify(this.data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }

    // Iniciar la aplicaci√≥n
    new App();
</script>
</body>
</html>
