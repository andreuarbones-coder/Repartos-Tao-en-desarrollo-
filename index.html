<script>
    (function() {
        // --- Configuraci√≥n de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4iPoxUkrOWdyWkMDnOSdoDJNg96SUKTs",
            authDomain: "repartos-tao.firebaseapp.com",
            projectId: "repartos-tao",
            storageBucket: "repartos-tao.firebasestorage.app",
            messagingSenderId: "794636373269",
            appId: "1:794636373269:web:12bb9f59b8fc50fe79ad1c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Habilitar persistencia offline (con la nueva sintaxis para evitar warning)
        db.enablePersistence({ synchronizeTabs: true }).catch(err => console.warn('Persistencia:', err));

        const customersCol = db.collection('customers');
        const productsCol = db.collection('products');
        const ordersCol = db.collection('orders');

        let customers = [];
        let products = [];
        let orders = [];

        const loader = document.getElementById('globalLoader');
        function showLoader() { loader.classList.remove('hidden'); }
        function hideLoader() { loader.classList.add('hidden'); }

        // Carga inicial con l√≠mite para mejorar velocidad
        async function loadCustomers() {
            const snap = await customersCol.orderBy('name').limit(500).get();
            customers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async function loadProducts() {
            const snap = await productsCol.orderBy('name').limit(1000).get();
            products = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateProductDatalist();
        }
        async function loadOrders() {
            const snap = await ordersCol.orderBy('date', 'desc').limit(500).get();
            orders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async function loadAllData() {
            showLoader();
            try {
                await Promise.all([loadCustomers(), loadProducts(), loadOrders()]);
                renderView(currentView);
            } catch (e) {
                console.error(e);
                alert('Error cargando datos');
            } finally {
                hideLoader();
            }
        }

        // Suscripciones en tiempo real (con l√≠mites tambi√©n)
        function subscribeToCustomers() {
            customersCol.orderBy('name').limit(500).onSnapshot(() => loadCustomers().then(() => renderView(currentView)));
        }
        function subscribeToProducts() {
            productsCol.orderBy('name').limit(1000).onSnapshot(() => loadProducts().then(() => renderView(currentView)));
        }
        function subscribeToOrders() {
            ordersCol.orderBy('date', 'desc').limit(500).onSnapshot(() => loadOrders().then(() => renderView(currentView)));
        }
        function startSubscriptions() {
            subscribeToCustomers();
            subscribeToProducts();
            subscribeToOrders();
        }

        // CRUD
        async function saveCustomer(cust) {
            showLoader();
            try {
                if (cust.id) await customersCol.doc(cust.id).set(cust);
                else await customersCol.add(cust);
            } catch (e) {
                console.error(e);
                alert('Error guardando cliente');
            } finally {
                hideLoader();
            }
        }
        async function deleteCustomer(id) {
            if (orders.some(o => o.customerId === id)) {
                alert('Cliente tiene pedidos, no se puede eliminar');
                return;
            }
            if (!confirm('¬øEliminar cliente?')) return;
            showLoader();
            try {
                await customersCol.doc(id).delete();
            } catch (e) {
                console.error(e);
                alert('Error eliminando cliente');
            } finally {
                hideLoader();
            }
        }
        async function saveProduct(prod) {
            showLoader();
            try {
                if (prod.id) await productsCol.doc(prod.id).set(prod);
                else await productsCol.add(prod);
            } catch (e) {
                console.error(e);
                alert('Error guardando producto');
            } finally {
                hideLoader();
            }
        }
        async function deleteProduct(id) {
            if (!confirm('¬øEliminar producto?')) return;
            showLoader();
            try {
                await productsCol.doc(id).delete();
            } catch (e) {
                console.error(e);
                alert('Error eliminando producto');
            } finally {
                hideLoader();
            }
        }
        // --- FUNCI√ìN SAVEORDER CORREGIDA ---
        async function saveOrder(order, file) {
            showLoader();
            try {
                if (file) {
                    const ref = storage.ref(`tickets/${Date.now()}`);
                    await ref.put(file);
                    order.ticketPhoto = await ref.getDownloadURL();
                } else {
                    order.ticketPhoto = order.ticketPhoto || '';
                }
                
                if (order.id) {
                    // Actualizar: incluir el id en el documento (el id del documento es el mismo)
                    await ordersCol.doc(order.id).set(order);
                } else {
                    // Crear nuevo: eliminar la propiedad 'id' para que no se guarde como campo undefined
                    const { id, ...orderWithoutId } = order;
                    await ordersCol.add(orderWithoutId);
                }
            } catch (e) {
                console.error('Error en saveOrder:', e);
                alert('Error guardando pedido: ' + e.message);
            } finally {
                hideLoader();
            }
        }
        async function deleteOrder(id) {
            if (!confirm('¬øEliminar pedido?')) return;
            showLoader();
            try {
                await ordersCol.doc(id).delete();
            } catch (e) {
                console.error(e);
                alert('Error eliminando pedido');
            } finally {
                hideLoader();
            }
        }
        async function updateOrderStatus(id, status) {
            showLoader();
            try {
                await ordersCol.doc(id).update({ status });
            } catch (e) {
                console.error(e);
                alert('Error actualizando estado');
            } finally {
                hideLoader();
            }
        }

        // Importar productos (batch)
        async function importProducts(newProductsArray) {
            showLoader();
            const total = newProductsArray.length;
            if (total === 0) {
                alert('No hay productos');
                hideLoader();
                return;
            }
            const BATCH_LIMIT = 500;
            const batches = [];
            for (let i = 0; i < total; i += BATCH_LIMIT) {
                const batch = db.batch();
                const chunk = newProductsArray.slice(i, i + BATCH_LIMIT);
                chunk.forEach(prod => {
                    const docRef = productsCol.doc();
                    batch.set(docRef, prod);
                });
                batches.push(batch.commit());
            }
            try {
                await Promise.all(batches);
                alert(`‚úÖ ${total} productos importados`);
            } catch (e) {
                console.error('Error importando:', e);
                alert('‚ùå Error al importar');
            } finally {
                hideLoader();
            }
        }
        async function clearAllProducts() {
            if (!confirm('¬øEliminar TODOS los productos?')) return;
            showLoader();
            try {
                const snap = await productsCol.get();
                const batch = db.batch();
                snap.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            } catch (e) {
                console.error(e);
                alert('Error limpiando');
            } finally {
                hideLoader();
            }
        }

        // Backup / Restore
        async function exportBackup() {
            showLoader();
            try {
                const [custSnap, prodSnap, orderSnap] = await Promise.all([
                    customersCol.get(), productsCol.get(), ordersCol.get()
                ]);
                const backup = {
                    customers: custSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    products: prodSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    orders: orderSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                };
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert('Error exportando');
            } finally {
                hideLoader();
            }
        }
        async function importBackup(file) {
            showLoader();
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                const batch = db.batch();
                const [custSnap, prodSnap, orderSnap] = await Promise.all([
                    customersCol.get(), productsCol.get(), ordersCol.get()
                ]);
                custSnap.docs.forEach(d => batch.delete(d.ref));
                prodSnap.docs.forEach(d => batch.delete(d.ref));
                orderSnap.docs.forEach(d => batch.delete(d.ref));
                data.customers?.forEach(c => batch.set(customersCol.doc(c.id || undefined), c));
                data.products?.forEach(p => batch.set(productsCol.doc(p.id || undefined), p));
                data.orders?.forEach(o => batch.set(ordersCol.doc(o.id || undefined), o));
                await batch.commit();
                alert('Restauraci√≥n exitosa');
            } catch (e) {
                console.error(e);
                alert('Error en restauraci√≥n');
            } finally {
                hideLoader();
            }
        }

        // Referencias DOM (igual que antes)
        const navBtns = document.querySelectorAll('.nav-btn');
        const newOrderBtn = document.getElementById('newOrderBtn');
        const searchOrders = document.getElementById('searchOrders');
        const statusFilter = document.getElementById('statusFilter');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const ordersListDiv = document.getElementById('ordersList');
        const customersListDiv = document.getElementById('customersList');
        const productListDiv = document.getElementById('productList');
        const newCustomerBtn = document.getElementById('newCustomerBtn');
        const productFile = document.getElementById('productFile');
        const dropZone = document.getElementById('dropZone');
        const clearProductsBtn = document.getElementById('clearProducts');
        const exportBackupBtn = document.getElementById('exportBackup');
        const importZone = document.getElementById('importZone');
        const importFile = document.getElementById('importFile');

        const orderModal = document.getElementById('orderModal');
        const quickCustomerModal = document.getElementById('quickCustomerModal');
        const customerModal = document.getElementById('customerModal');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        const quickAddCustomerBtn = document.getElementById('quickAddCustomerBtn');
        const quickCustomerForm = document.getElementById('quickCustomerForm');
        const cancelQuickBtn = document.getElementById('cancelQuickBtn');
        const quickName = document.getElementById('quickName');
        const quickPhone = document.getElementById('quickPhone');
        const quickAddress = document.getElementById('quickAddress');
        const quickEmail = document.getElementById('quickEmail');

        const orderForm = document.getElementById('orderForm');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const addProductBtn = document.getElementById('addProductBtn');
        const productsContainer = document.getElementById('productsContainer');
        const customerSelect = document.getElementById('customerSelect');
        const orderDate = document.getElementById('orderDate');
        const orderStatus = document.getElementById('orderStatus');
        const orderComments = document.getElementById('orderComments');
        const ticketPhoto = document.getElementById('ticketPhoto');
        const photoPreviewContainer = document.getElementById('photoPreviewContainer');
        const orderIdHidden = document.getElementById('orderId');
        const modalTitle = document.getElementById('modalTitle');

        const customerForm = document.getElementById('customerForm');
        const cancelCustomerBtn = document.getElementById('cancelCustomerBtn');
        const customerIdHidden = document.getElementById('customerId');
        const customerName = document.getElementById('customerName');
        const customerPhone = document.getElementById('customerPhone');
        const customerAddress = document.getElementById('customerAddress');
        const customerEmail = document.getElementById('customerEmail');
        const customerModalTitle = document.getElementById('customerModalTitle');

        let currentView = 'orders';

        function setActiveView(view) {
            currentView = view;
            document.querySelectorAll('.views-container > div').forEach(div => div.classList.remove('active-view'));
            document.getElementById(`view-${view}`).classList.add('active-view');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-view="${view}"]`).classList.add('active');
            renderView(view);
        }
        navBtns.forEach(btn => btn.addEventListener('click', () => setActiveView(btn.dataset.view)));

        function renderView(view) {
            if (view === 'orders') renderOrders();
            if (view === 'customers') renderCustomers();
            if (view === 'products') renderProductsList();
        }

        // --- Renderizados con data-label (igual) ---
        function renderOrders() {
            const filterText = searchOrders.value.toLowerCase();
            const filterStatus = statusFilter.value;
            const from = dateFrom.value;
            const to = dateTo.value;

            let filtered = orders.filter(o => {
                if (filterStatus !== 'todos' && o.status !== filterStatus) return false;
                const d = o.date ? o.date.split('T')[0] : '';
                if (from && d < from) return false;
                if (to && d > to) return false;
                if (filterText) {
                    const c = customers.find(c => c.id === o.customerId) || {};
                    const txt = (c.name + ' ' + (c.phone||'') + ' ' + (c.address||'') + ' ' + (c.email||'') + ' ' + (o.comments||'') + ' ' + o.items.map(i=>i.productName).join(' ')).toLowerCase();
                    return txt.includes(filterText);
                }
                return true;
            });

            if (!filtered.length) {
                ordersListDiv.innerHTML = '<p class="card">No hay pedidos.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Fecha</th><th>Cliente</th><th>Estado</th><th>Productos</th><th>Comentarios</th><th>Acciones</th></tr></thead><tbody>';
            filtered.forEach(o => {
                const c = customers.find(c => c.id === o.customerId) || { name: '?' };
                const itemsHtml = o.items.map(i => `<li>${i.productName} x${i.quantity} ($${i.price})</li>`).join('');
                html += `<tr>
                    <td data-label="Fecha">${o.date ? new Date(o.date).toLocaleString() : ''}</td>
                    <td data-label="Cliente">${c.name}</td>
                    <td data-label="Estado">
                        <span class="badge ${o.status}" data-order-id="${o.id}">${o.status}</span>
                        <div class="status-menu" id="status-menu-${o.id}">
                            <button data-status="pendiente">Pendiente</button>
                            <button data-status="entregado">Entregado</button>
                            <button data-status="incompleto">Incompleto</button>
                        </div>
                    </td>
                    <td data-label="Productos"><ul class="product-list">${itemsHtml}</ul></td>
                    <td data-label="Comentarios">${o.comments || ''}</td>
                    <td class="actions-cell" data-label="Acciones">
                        <button class="icon-btn edit-order" data-id="${o.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-order" data-id="${o.id}">üóëÔ∏è</button>
                        ${o.ticketPhoto ? `<button class="icon-btn view-photo" data-photo="${o.ticketPhoto}">üì∑</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            ordersListDiv.innerHTML = html;

            // Eventos
            document.querySelectorAll('.edit-order').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                openOrderModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-order').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                deleteOrder(btn.dataset.id);
            }));
            document.querySelectorAll('.view-photo').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                modalImage.src = btn.dataset.photo;
                imageModal.style.display = 'flex';
            }));
            document.querySelectorAll('.badge').forEach(badge => {
                badge.addEventListener('click', e => {
                    e.stopPropagation();
                    const menu = document.getElementById(`status-menu-${badge.dataset.orderId}`);
                    document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
                    const rect = badge.getBoundingClientRect();
                    menu.style.top = rect.bottom + window.scrollY + 'px';
                    menu.style.left = rect.left + window.scrollX + 'px';
                    menu.style.display = 'block';
                });
            });
            document.querySelectorAll('.status-menu button').forEach(btn => {
                btn.addEventListener('click', async e => {
                    e.stopPropagation();
                    const menu = btn.closest('.status-menu');
                    const id = menu.id.replace('status-menu-', '');
                    await updateOrderStatus(id, btn.dataset.status);
                    menu.style.display = 'none';
                });
            });
            document.addEventListener('click', () => {
                document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
            });
        }

        function renderCustomers() {
            if (!customers.length) {
                customersListDiv.innerHTML = '<p class="card">No hay clientes.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Direcci√≥n</th><th>Email</th><th>Acciones</th></tr></thead><tbody>';
            customers.forEach(c => {
                html += `<tr>
                    <td data-label="Nombre">${c.name}</td>
                    <td data-label="Tel√©fono">${c.phone || ''}</td>
                    <td data-label="Direcci√≥n">${c.address || ''}</td>
                    <td data-label="Email">${c.email || ''}</td>
                    <td class="actions-cell" data-label="Acciones">
                        <button class="icon-btn edit-customer" data-id="${c.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-customer" data-id="${c.id}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            customersListDiv.innerHTML = html;
            document.querySelectorAll('.edit-customer').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                openCustomerModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-customer').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                deleteCustomer(btn.dataset.id);
            }));
        }

        function renderProductsList() {
            if (!products.length) {
                productListDiv.innerHTML = '<p>No hay productos cargados.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Nombre</th><th>Precio</th><th>Acciones</th></tr></thead><tbody>';
            products.slice(0, 100).forEach(p => {
                html += `<tr>
                    <td data-label="Nombre">${p.name}</td>
                    <td data-label="Precio">${p.price ? '$' + p.price : '-'}</td>
                    <td class="actions-cell" data-label="Acciones">
                        <button class="icon-btn edit-product" data-id="${p.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-product" data-id="${p.id}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            if (products.length > 100) html += '<tr><td colspan="3">... y ' + (products.length-100) + ' m√°s</td></tr>';
            html += '</tbody></table>';
            productListDiv.innerHTML = html;
            document.querySelectorAll('.edit-product').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                openProductModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-product').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                deleteProduct(btn.dataset.id);
            }));
        }

        function openProductModal(id) {
            alert('Edici√≥n individual no implementada. Us√° Excel.');
        }

        function openOrderModal(id) {
            modalTitle.innerText = id ? '‚úèÔ∏è Editar Pedido' : '‚ûï Nuevo Pedido';
            orderForm.reset();
            orderIdHidden.value = '';
            productsContainer.innerHTML = '';
            photoPreviewContainer.innerHTML = '';
            updateCustomerSelect();
            if (id) {
                const o = orders.find(o => o.id === id);
                if (!o) return;
                orderIdHidden.value = o.id;
                customerSelect.value = o.customerId;
                orderDate.value = o.date;
                orderStatus.value = o.status;
                orderComments.value = o.comments || '';
                o.items.forEach(item => addProductRow(item));
                if (o.ticketPhoto) {
                    const img = document.createElement('img');
                    img.src = o.ticketPhoto;
                    img.className = 'photo-preview';
                    photoPreviewContainer.appendChild(img);
                }
            } else {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                orderDate.value = now.toISOString().slice(0, 16);
                addProductRow();
            }
            orderModal.style.display = 'flex';
        }

        function updateCustomerSelect() {
            customerSelect.innerHTML = '<option value="">Seleccionar cliente</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function addProductRow(item) {
            const div = document.createElement('div');
            div.className = 'product-item';
            div.innerHTML = `
                <input type="text" placeholder="Producto" list="productDatalist" value="${item ? item.productName : ''}" class="product-name">
                <input type="number" placeholder="Cant" value="${item ? item.quantity : 1}" min="1" style="width:80px;" class="product-qty">
                <input type="number" placeholder="Precio" value="${item ? item.price : ''}" min="0" step="0.01" style="width:100px;" class="product-price">
                <button type="button" class="remove-product">‚úï</button>
            `;
            div.querySelector('.remove-product').addEventListener('click', () => div.remove());
            productsContainer.appendChild(div);
        }

        cancelOrderBtn.addEventListener('click', () => orderModal.style.display = 'none');
        window.addEventListener('click', e => {
            if (e.target === orderModal) orderModal.style.display = 'none';
            if (e.target === quickCustomerModal) quickCustomerModal.style.display = 'none';
            if (e.target === customerModal) customerModal.style.display = 'none';
            if (e.target === imageModal) imageModal.style.display = 'none';
        });

        orderForm.addEventListener('submit', async e => {
            e.preventDefault();
            const customerId = customerSelect.value;
            if (!customerId) return alert('Seleccion√° un cliente');
            const items = [];
            document.querySelectorAll('#productsContainer .product-item').forEach(row => {
                const name = row.querySelector('.product-name').value.trim();
                if (!name) return;
                items.push({
                    productName: name,
                    quantity: parseInt(row.querySelector('.product-qty').value) || 1,
                    price: parseFloat(row.querySelector('.product-price').value) || 0
                });
            });
            if (!items.length) return alert('Agreg√° al menos un producto');
            const file = ticketPhoto.files[0];
            const order = {
                // Si hay id, lo incluimos; si no, no ponemos la propiedad
                ...(orderIdHidden.value ? { id: orderIdHidden.value } : {}),
                customerId,
                date: orderDate.value,
                status: orderStatus.value,
                comments: orderComments.value,
                items,
                ticketPhoto: ''
            };
            await saveOrder(order, file);
            orderModal.style.display = 'none';
        });

        ticketPhoto.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => photoPreviewContainer.innerHTML = `<img src="${ev.target.result}" class="photo-preview">`;
                reader.readAsDataURL(file);
            }
        });

        addProductBtn.addEventListener('click', () => addProductRow());

        quickAddCustomerBtn.addEventListener('click', () => {
            quickCustomerForm.reset();
            quickCustomerModal.style.display = 'flex';
        });
        cancelQuickBtn.addEventListener('click', () => quickCustomerModal.style.display = 'none');
        quickCustomerForm.addEventListener('submit', async e => {
            e.preventDefault();
            const cust = {
                name: quickName.value.trim(),
                phone: quickPhone.value.trim(),
                address: quickAddress.value.trim(),
                email: quickEmail.value.trim()
            };
            if (!cust.name) return alert('Nombre obligatorio');
            await saveCustomer(cust);
            quickCustomerModal.style.display = 'none';
        });

        function openCustomerModal(id) {
            customerModalTitle.innerText = id ? '‚úèÔ∏è Editar Cliente' : 'üë§ Nuevo Cliente';
            customerForm.reset();
            customerIdHidden.value = '';
            if (id) {
                const c = customers.find(c => c.id === id);
                if (c) {
                    customerIdHidden.value = c.id;
                    customerName.value = c.name;
                    customerPhone.value = c.phone || '';
                    customerAddress.value = c.address || '';
                    customerEmail.value = c.email || '';
                }
            }
            customerModal.style.display = 'flex';
        }
        customerForm.addEventListener('submit', async e => {
            e.preventDefault();
            const cust = {
                id: customerIdHidden.value || undefined,
                name: customerName.value.trim(),
                phone: customerPhone.value.trim(),
                address: customerAddress.value.trim(),
                email: customerEmail.value.trim()
            };
            if (!cust.name) return alert('Nombre obligatorio');
            await saveCustomer(cust);
            customerModal.style.display = 'none';
        });
        cancelCustomerBtn.addEventListener('click', () => customerModal.style.display = 'none');
        newCustomerBtn.addEventListener('click', () => openCustomerModal());
        newOrderBtn.addEventListener('click', () => openOrderModal());

        searchOrders.addEventListener('input', renderOrders);
        statusFilter.addEventListener('change', renderOrders);
        dateFrom.addEventListener('change', renderOrders);
        dateTo.addEventListener('change', renderOrders);

        // Manejador de archivo de productos
        function handleProductFile(file) {
            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();
            dropZone.innerHTML = `<span class="spinner"></span> Procesando... 0%`;
            dropZone.style.pointerEvents = 'none';

            const updateProgress = (percent) => {
                dropZone.innerHTML = `<span class="spinner"></span> Procesando... ${percent}%`;
            };

            if (ext === 'csv') {
                reader.onload = (ev) => {
                    try {
                        const prods = parseCSV(ev.target.result);
                        importProducts(prods).then(() => {
                            dropZone.innerHTML = '‚úÖ Productos cargados';
                        }).catch(() => {
                            dropZone.innerHTML = '‚ùå Error';
                        }).finally(() => {
                            dropZone.style.pointerEvents = 'auto';
                            setTimeout(() => resetDropZone(), 2000);
                        });
                    } catch (err) {
                        alert('Error CSV: ' + err.message);
                        resetDropZone();
                    }
                };
                reader.readAsText(file);
            } else if (ext === 'xls' || ext === 'xlsx') {
                reader.onload = (ev) => {
                    try {
                        const data = new Uint8Array(ev.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        if (rows.length < 2) throw new Error('Sin datos');
                        const headers = rows[0].map(h => String(h).toLowerCase().trim());
                        const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto');
                        if (nameIdx === -1) throw new Error('Columna "nombre" no encontrada');
                        const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe'));

                        const prods = [];
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row || !row[nameIdx]) continue;
                            const name = String(row[nameIdx]).trim();
                            if (!name) continue;
                            let price;
                            if (priceIdx !== -1 && row[priceIdx] !== undefined) {
                                const val = row[priceIdx];
                                if (typeof val === 'number') price = val;
                                else if (typeof val === 'string') {
                                    const num = parseFloat(val.replace(/[^\d.,-]/g, '').replace(',', '.'));
                                    if (!isNaN(num)) price = num;
                                }
                            }
                            prods.push({ name, price });
                            if (i % 100 === 0) updateProgress(Math.round((i / rows.length) * 100));
                        }
                        updateProgress(100);
                        importProducts(prods).then(() => {
                            dropZone.innerHTML = '‚úÖ Productos cargados';
                        }).catch(() => {
                            dropZone.innerHTML = '‚ùå Error';
                        }).finally(() => {
                            dropZone.style.pointerEvents = 'auto';
                            setTimeout(() => resetDropZone(), 2000);
                        });
                    } catch (err) {
                        alert('Error Excel: ' + err.message);
                        resetDropZone();
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Formato no soportado');
                resetDropZone();
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto');
            if (nameIdx === -1) throw new Error('Columna "nombre" no encontrada');
            const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe'));
            const prods = [];
            for (let i = 1; i < lines.length; i++) {
                const vals = lines[i].split(',').map(v => v.trim());
                if (!vals[nameIdx]) continue;
                const name = vals[nameIdx];
                let price;
                if (priceIdx !== -1 && vals[priceIdx]) {
                    const num = parseFloat(vals[priceIdx].replace(/[^\d.,-]/g, '').replace(',', '.'));
                    if (!isNaN(num)) price = num;
                }
                prods.push({ name, price });
            }
            return prods;
        }

        function resetDropZone(msg) {
            dropZone.innerHTML = msg || 'üìÇ Arrastr√° o hac√© clic para seleccionar archivo';
            dropZone.style.pointerEvents = 'auto';
        }

        dropZone.addEventListener('click', () => productFile.click());
        dropZone.addEventListener('dragover', e => e.preventDefault());
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files[0]) handleProductFile(e.dataTransfer.files[0]);
        });
        productFile.addEventListener('change', e => {
            if (e.target.files[0]) handleProductFile(e.target.files[0]);
        });

        clearProductsBtn.addEventListener('click', clearAllProducts);
        exportBackupBtn.addEventListener('click', exportBackup);
        importZone.addEventListener('click', () => importFile.click());
        importZone.addEventListener('dragover', e => e.preventDefault());
        importZone.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files[0]) importBackup(e.dataTransfer.files[0]);
        });
        importFile.addEventListener('change', e => {
            if (e.target.files[0]) importBackup(e.target.files[0]);
        });

        const datalist = document.createElement('datalist');
        datalist.id = 'productDatalist';
        document.body.appendChild(datalist);
        function updateProductDatalist() {
            datalist.innerHTML = products.map(p => `<option value="${p.name}">${p.price ? '$'+p.price : ''}</option>`).join('');
        }

        document.querySelector('#imageModal .close').addEventListener('click', () => imageModal.style.display = 'none');

        // Inicio
        loadAllData().then(() => {
            startSubscriptions();
            setActiveView('orders');
        });
    })();
</script>
