<script>
    (function() {
        // --- Configuraci√≥n de Firebase (ya con tus datos) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4iPoxUkrOWdyWkMDnOSdoDJNg96SUKTs",
            authDomain: "repartos-tao.firebaseapp.com",
            projectId: "repartos-tao",
            storageBucket: "repartos-tao.firebasestorage.app",
            messagingSenderId: "794636373269",
            appId: "1:794636373269:web:12bb9f59b8fc50fe79ad1c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Habilitar persistencia offline
        db.enablePersistence({ synchronizeTabs: true })
          .catch(err => console.warn('Error de persistencia:', err));

        // --- Referencias a colecciones ---
        const customersCol = db.collection('customers');
        const productsCol = db.collection('products');
        const ordersCol = db.collection('orders');

        // --- Estado local ---
        let customers = [];
        let products = [];
        let orders = [];

        // --- Loader ---
        const loader = document.getElementById('globalLoader');
        function showLoader() { loader.classList.remove('hidden'); }
        function hideLoader() { loader.classList.add('hidden'); }

        // --- Funciones de carga ---
        function loadCustomers() {
            return customersCol.orderBy('name').get().then(snapshot => {
                customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        }
        function loadProducts() {
            return productsCol.orderBy('name').get().then(snapshot => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateProductDatalist();
            });
        }
        function loadOrders() {
            return ordersCol.orderBy('date', 'desc').get().then(snapshot => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        }

        async function loadAllData() {
            showLoader();
            try {
                await Promise.all([loadCustomers(), loadProducts(), loadOrders()]);
                renderView(currentView);
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al conectar con Firebase. Revis√° la consola.');
            } finally {
                hideLoader();
            }
        }

        // --- Suscripciones en tiempo real ---
        function subscribeToCustomers() {
            customersCol.orderBy('name').onSnapshot(() => {
                loadCustomers().then(() => renderView(currentView));
            });
        }
        function subscribeToProducts() {
            productsCol.orderBy('name').onSnapshot(() => {
                loadProducts().then(() => renderView(currentView));
            });
        }
        function subscribeToOrders() {
            ordersCol.orderBy('date', 'desc').onSnapshot(() => {
                loadOrders().then(() => renderView(currentView));
            });
        }

        function startSubscriptions() {
            subscribeToCustomers();
            subscribeToProducts();
            subscribeToOrders();
        }

        // --- CRUD (sin cambios importantes) ---
        async function saveCustomer(customerData) {
            showLoader();
            try {
                if (customerData.id) {
                    await customersCol.doc(customerData.id).set(customerData);
                } else {
                    const docRef = await customersCol.add(customerData);
                    customerData.id = docRef.id;
                }
            } catch (error) {
                console.error('Error guardando cliente:', error);
                alert('Error al guardar cliente');
            } finally {
                hideLoader();
            }
        }

        async function deleteCustomer(id) {
            if (orders.some(o => o.customerId === id)) {
                alert('No se puede eliminar un cliente con pedidos asociados.');
                return;
            }
            if (confirm('¬øEliminar cliente?')) {
                showLoader();
                try {
                    await customersCol.doc(id).delete();
                } catch (error) {
                    console.error('Error eliminando cliente:', error);
                    alert('Error al eliminar cliente');
                } finally {
                    hideLoader();
                }
            }
        }

        async function saveProduct(productData) {
            showLoader();
            try {
                if (productData.id) {
                    await productsCol.doc(productData.id).set(productData);
                } else {
                    const docRef = await productsCol.add(productData);
                    productData.id = docRef.id;
                }
            } catch (error) {
                console.error('Error guardando producto:', error);
                alert('Error al guardar producto');
            } finally {
                hideLoader();
            }
        }

        async function deleteProduct(id) {
            if (confirm('¬øEliminar producto?')) {
                showLoader();
                try {
                    await productsCol.doc(id).delete();
                } catch (error) {
                    console.error('Error eliminando producto:', error);
                    alert('Error al eliminar producto');
                } finally {
                    hideLoader();
                }
            }
        }

        async function saveOrder(orderData, file = null) {
            showLoader();
            try {
                if (file) {
                    const storageRef = storage.ref(`tickets/${orderData.id || Date.now()}_${Date.now()}`);
                    await storageRef.put(file);
                    const url = await storageRef.getDownloadURL();
                    orderData.ticketPhoto = url;
                } else if (!orderData.ticketPhoto) {
                    orderData.ticketPhoto = '';
                }

                if (orderData.id) {
                    await ordersCol.doc(orderData.id).set(orderData);
                } else {
                    const docRef = await ordersCol.add(orderData);
                    orderData.id = docRef.id;
                }
            } catch (error) {
                console.error('Error guardando pedido:', error);
                alert('Error al guardar pedido');
            } finally {
                hideLoader();
            }
        }

        async function deleteOrder(id) {
            if (confirm('¬øEliminar pedido?')) {
                showLoader();
                try {
                    await ordersCol.doc(id).delete();
                } catch (error) {
                    console.error('Error eliminando pedido:', error);
                    alert('Error al eliminar pedido');
                } finally {
                    hideLoader();
                }
            }
        }

        async function updateOrderStatus(id, newStatus) {
            showLoader();
            try {
                await ordersCol.doc(id).update({ status: newStatus });
            } catch (error) {
                console.error('Error actualizando estado:', error);
                alert('Error al actualizar estado');
            } finally {
                hideLoader();
            }
        }

        // --- NUEVA: Importaci√≥n de productos con soporte para lotes grandes ---
        async function importProducts(newProductsArray) {
            showLoader();
            const total = newProductsArray.length;
            if (total === 0) {
                alert('No hay productos para importar.');
                hideLoader();
                return;
            }

            const BATCH_LIMIT = 500; // Firestore m√°ximo por batch
            const batches = [];
            
            for (let i = 0; i < total; i += BATCH_LIMIT) {
                const batch = db.batch();
                const chunk = newProductsArray.slice(i, i + BATCH_LIMIT);
                chunk.forEach(prod => {
                    const docRef = productsCol.doc(); // ID autom√°tico
                    batch.set(docRef, prod);
                });
                batches.push(batch.commit());
            }

            try {
                await Promise.all(batches);
                alert(`‚úÖ ${total} productos importados correctamente.`);
            } catch (error) {
                console.error('Error importando productos:', error);
                alert('‚ùå Error al importar productos. Revis√° la consola (F12).');
            } finally {
                hideLoader();
            }
        }

        async function clearAllProducts() {
            if (!confirm('¬øEliminar TODOS los productos?')) return;
            showLoader();
            try {
                const snapshot = await productsCol.get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            } catch (error) {
                console.error('Error limpiando productos:', error);
                alert('Error al limpiar productos');
            } finally {
                hideLoader();
            }
        }

        // --- Backup / Restore ---
        async function exportBackup() {
            showLoader();
            try {
                const [custSnap, prodSnap, orderSnap] = await Promise.all([
                    customersCol.get(),
                    productsCol.get(),
                    ordersCol.get()
                ]);
                const backup = {
                    customers: custSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    products: prodSnap.docs.map(d => ({ id: d.id, ...d.data() })),
                    orders: orderSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                };
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exportando backup:', error);
                alert('Error al exportar');
            } finally {
                hideLoader();
            }
        }

        async function importBackup(file) {
            showLoader();
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                const batch = db.batch();

                const [custSnap, prodSnap, orderSnap] = await Promise.all([
                    customersCol.get(),
                    productsCol.get(),
                    ordersCol.get()
                ]);
                custSnap.docs.forEach(doc => batch.delete(doc.ref));
                prodSnap.docs.forEach(doc => batch.delete(doc.ref));
                orderSnap.docs.forEach(doc => batch.delete(doc.ref));

                if (data.customers) data.customers.forEach(c => {
                    const ref = customersCol.doc(c.id || undefined);
                    batch.set(ref, c);
                });
                if (data.products) data.products.forEach(p => {
                    const ref = productsCol.doc(p.id || undefined);
                    batch.set(ref, p);
                });
                if (data.orders) data.orders.forEach(o => {
                    const ref = ordersCol.doc(o.id || undefined);
                    batch.set(ref, o);
                });

                await batch.commit();
                alert('Restauraci√≥n exitosa');
            } catch (error) {
                console.error('Error importando backup:', error);
                alert('Archivo inv√°lido o error en la restauraci√≥n');
            } finally {
                hideLoader();
            }
        }

        // ----- Referencias DOM -----
        const viewsContainer = document.getElementById('viewsContainer');
        const navBtns = document.querySelectorAll('.nav-btn');
        const newOrderBtn = document.getElementById('newOrderBtn');
        const searchOrders = document.getElementById('searchOrders');
        const statusFilter = document.getElementById('statusFilter');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const ordersListDiv = document.getElementById('ordersList');
        const customersListDiv = document.getElementById('customersList');
        const productListDiv = document.getElementById('productList');
        const newCustomerBtn = document.getElementById('newCustomerBtn');
        const productFile = document.getElementById('productFile');
        const dropZone = document.getElementById('dropZone');
        const clearProductsBtn = document.getElementById('clearProducts');
        const exportBackupBtn = document.getElementById('exportBackup');
        const importZone = document.getElementById('importZone');
        const importFile = document.getElementById('importFile');

        // Modales
        const orderModal = document.getElementById('orderModal');
        const quickCustomerModal = document.getElementById('quickCustomerModal');
        const customerModal = document.getElementById('customerModal');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        const quickAddCustomerBtn = document.getElementById('quickAddCustomerBtn');
        const quickCustomerForm = document.getElementById('quickCustomerForm');
        const cancelQuickBtn = document.getElementById('cancelQuickBtn');
        const quickName = document.getElementById('quickName');
        const quickPhone = document.getElementById('quickPhone');
        const quickAddress = document.getElementById('quickAddress');
        const quickEmail = document.getElementById('quickEmail');

        const orderForm = document.getElementById('orderForm');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const addProductBtn = document.getElementById('addProductBtn');
        const productsContainer = document.getElementById('productsContainer');
        const customerSelect = document.getElementById('customerSelect');
        const orderDate = document.getElementById('orderDate');
        const orderStatus = document.getElementById('orderStatus');
        const orderComments = document.getElementById('orderComments');
        const ticketPhoto = document.getElementById('ticketPhoto');
        const photoPreviewContainer = document.getElementById('photoPreviewContainer');
        const orderIdHidden = document.getElementById('orderId');
        const modalTitle = document.getElementById('modalTitle');

        const customerForm = document.getElementById('customerForm');
        const cancelCustomerBtn = document.getElementById('cancelCustomerBtn');
        const customerIdHidden = document.getElementById('customerId');
        const customerName = document.getElementById('customerName');
        const customerPhone = document.getElementById('customerPhone');
        const customerAddress = document.getElementById('customerAddress');
        const customerEmail = document.getElementById('customerEmail');
        const customerModalTitle = document.getElementById('customerModalTitle');

        // --- Variables de vista ---
        let currentView = 'orders';

        function setActiveView(viewId) {
            currentView = viewId;
            document.querySelectorAll('.views-container > div').forEach(div => div.classList.remove('active-view'));
            document.getElementById(`view-${viewId}`).classList.add('active-view');
            navBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-view="${viewId}"]`).classList.add('active');
            renderView(viewId);
        }

        navBtns.forEach(btn => btn.addEventListener('click', () => setActiveView(btn.dataset.view)));

        function renderView(view) {
            if (view === 'orders') renderOrders();
            if (view === 'customers') renderCustomers();
            if (view === 'products') renderProductsList();
        }

        // --- Renderizado (igual que antes) ---
        function renderOrders() {
            const filterText = searchOrders ? searchOrders.value.toLowerCase() : '';
            const filterStatus = statusFilter ? statusFilter.value : 'todos';
            const fromDate = dateFrom ? dateFrom.value : '';
            const toDate = dateTo ? dateTo.value : '';

            let filtered = orders.filter(order => {
                if (filterStatus !== 'todos' && order.status !== filterStatus) return false;
                const orderDateStr = order.date ? order.date.split('T')[0] : '';
                if (fromDate && orderDateStr < fromDate) return false;
                if (toDate && orderDateStr > toDate) return false;
                if (filterText) {
                    const customer = customers.find(c => c.id === order.customerId) || {};
                    const customerName = (customer.name || '').toLowerCase();
                    const customerPhone = (customer.phone || '').toLowerCase();
                    const customerAddress = (customer.address || '').toLowerCase();
                    const customerEmail = (customer.email || '').toLowerCase();
                    const comments = (order.comments || '').toLowerCase();
                    const productNames = order.items.map(i => i.productName.toLowerCase()).join(' ');
                    const hayMatch = customerName.includes(filterText) ||
                                    customerPhone.includes(filterText) ||
                                    customerAddress.includes(filterText) ||
                                    customerEmail.includes(filterText) ||
                                    comments.includes(filterText) ||
                                    productNames.includes(filterText);
                    if (!hayMatch) return false;
                }
                return true;
            });

            if (!ordersListDiv) return;
            if (filtered.length === 0) {
                ordersListDiv.innerHTML = '<p class="card">No hay pedidos.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Fecha</th><th>Cliente</th><th>Estado</th><th>Productos</th><th>Comentarios</th><th>Acciones</th></tr></thead><tbody>';
            filtered.forEach(order => {
                const customer = customers.find(c => c.id === order.customerId) || { name: '?' };
                const itemsList = order.items.map(i => `<li>${i.productName} x${i.quantity} ($${i.price})</li>`).join('');
                const itemsHtml = `<ul class="product-list">${itemsList}</ul>`;
                html += `<tr data-order-id="${order.id}">
                    <td>${order.date ? new Date(order.date).toLocaleString() : ''}</td>
                    <td>${customer.name}</td>
                    <td>
                        <span class="badge ${order.status}" data-order-id="${order.id}">${order.status}</span>
                        <div class="status-menu" id="status-menu-${order.id}">
                            <button data-status="pendiente">Pendiente</button>
                            <button data-status="entregado">Entregado</button>
                            <button data-status="incompleto">Incompleto</button>
                        </div>
                    </td>
                    <td>${itemsHtml}</td>
                    <td>${order.comments || ''}</td>
                    <td class="actions-cell">
                        <button class="icon-btn edit-order" data-id="${order.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-order" data-id="${order.id}">üóëÔ∏è</button>
                        ${order.ticketPhoto ? `<button class="icon-btn view-photo" data-photo="${order.ticketPhoto}">üì∑</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            ordersListDiv.innerHTML = html;

            // Eventos
            document.querySelectorAll('.edit-order').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openOrderModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-order').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteOrder(btn.dataset.id);
            }));
            document.querySelectorAll('.view-photo').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const photo = btn.dataset.photo;
                    if (photo) {
                        modalImage.src = photo;
                        imageModal.style.display = 'flex';
                    }
                });
            });
            document.querySelectorAll('.badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const orderId = badge.dataset.orderId;
                    const menu = document.getElementById(`status-menu-${orderId}`);
                    document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
                    const rect = badge.getBoundingClientRect();
                    menu.style.top = rect.bottom + window.scrollY + 'px';
                    menu.style.left = rect.left + window.scrollX + 'px';
                    menu.style.display = 'block';
                });
            });
            document.querySelectorAll('.status-menu button').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const menu = btn.closest('.status-menu');
                    const orderId = menu.id.replace('status-menu-', '');
                    const newStatus = btn.dataset.status;
                    await updateOrderStatus(orderId, newStatus);
                    menu.style.display = 'none';
                });
            });
            document.addEventListener('click', () => {
                document.querySelectorAll('.status-menu').forEach(m => m.style.display = 'none');
            });
        }

        function renderCustomers() {
            if (!customersListDiv) return;
            if (customers.length === 0) {
                customersListDiv.innerHTML = '<p class="card">No hay clientes.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Direcci√≥n</th><th>Email</th><th>Acciones</th></tr></thead><tbody>';
            customers.forEach(c => {
                html += `<tr>
                    <td>${c.name}</td>
                    <td>${c.phone || ''}</td>
                    <td>${c.address || ''}</td>
                    <td>${c.email || ''}</td>
                    <td class="actions-cell">
                        <button class="icon-btn edit-customer" data-id="${c.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-customer" data-id="${c.id}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            customersListDiv.innerHTML = html;
            document.querySelectorAll('.edit-customer').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openCustomerModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-customer').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCustomer(btn.dataset.id);
            }));
        }

        function renderProductsList() {
            if (!productListDiv) return;
            if (products.length === 0) {
                productListDiv.innerHTML = '<p>No hay productos cargados. Sub√≠ un archivo CSV o Excel.</p>';
                return;
            }
            let html = '<table><thead><tr><th>Nombre</th><th>Precio</th><th>Acciones</th></tr></thead><tbody>';
            products.slice(0, 100).forEach(p => {
                html += `<tr>
                    <td>${p.name}</td>
                    <td>${p.price ? '$' + p.price : '-'}</td>
                    <td class="actions-cell">
                        <button class="icon-btn edit-product" data-id="${p.id}">‚úèÔ∏è</button>
                        <button class="icon-btn delete-product" data-id="${p.id}">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            if (products.length > 100) html += '<tr><td colspan="3">... y ' + (products.length-100) + ' m√°s</td></tr>';
            html += '</tbody></table>';
            productListDiv.innerHTML = html;
            document.querySelectorAll('.edit-product').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openProductModal(btn.dataset.id);
            }));
            document.querySelectorAll('.delete-product').forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteProduct(btn.dataset.id);
            }));
        }

        function openProductModal(id = null) {
            // Implementar si quer√©s edici√≥n individual
            alert('Funci√≥n no implementada, pero pod√©s editar desde el Excel o borrar y crear');
        }

        function openOrderModal(orderId = null) {
            const isEdit = !!orderId;
            modalTitle.innerText = isEdit ? '‚úèÔ∏è Editar Pedido' : '‚ûï Nuevo Pedido';
            orderForm.reset();
            orderIdHidden.value = '';
            productsContainer.innerHTML = '';
            photoPreviewContainer.innerHTML = '';
            updateCustomerSelect();
            if (isEdit) {
                const order = orders.find(o => o.id === orderId);
                if (!order) return;
                orderIdHidden.value = order.id;
                customerSelect.value = order.customerId;
                orderDate.value = order.date;
                orderStatus.value = order.status;
                orderComments.value = order.comments || '';
                order.items.forEach(item => addProductRow(item));
                if (order.ticketPhoto) {
                    const img = document.createElement('img');
                    img.src = order.ticketPhoto;
                    img.className = 'photo-preview';
                    photoPreviewContainer.appendChild(img);
                }
            } else {
                const now = new Date();
                const tzOffset = now.getTimezoneOffset() * 60000;
                const localISOTime = new Date(now - tzOffset).toISOString().slice(0, 16);
                orderDate.value = localISOTime;
                addProductRow();
            }
            orderModal.style.display = 'flex';
        }

        function updateCustomerSelect() {
            customerSelect.innerHTML = '<option value="">Seleccionar cliente</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function addProductRow(item = null) {
            const div = document.createElement('div');
            div.className = 'product-item';
            div.innerHTML = `
                <input type="text" placeholder="Producto" list="productDatalist" value="${item ? item.productName : ''}" class="product-name">
                <input type="number" placeholder="Cant" value="${item ? item.quantity : 1}" min="1" style="width:80px;" class="product-qty">
                <input type="number" placeholder="Precio" value="${item ? item.price : ''}" min="0" step="0.01" style="width:100px;" class="product-price">
                <button type="button" class="remove-product">‚úï</button>
            `;
            div.querySelector('.remove-product').addEventListener('click', () => div.remove());
            productsContainer.appendChild(div);
        }

        cancelOrderBtn.addEventListener('click', () => orderModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === orderModal) orderModal.style.display = 'none';
            if (e.target === quickCustomerModal) quickCustomerModal.style.display = 'none';
            if (e.target === customerModal) customerModal.style.display = 'none';
            if (e.target === imageModal) imageModal.style.display = 'none';
        });

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = customerSelect.value;
            if (!customerId) return alert('Seleccion√° un cliente');
            const items = [];
            document.querySelectorAll('#productsContainer .product-item').forEach(row => {
                const nameInput = row.querySelector('.product-name');
                const qtyInput = row.querySelector('.product-qty');
                const priceInput = row.querySelector('.product-price');
                if (nameInput.value.trim() !== '') {
                    items.push({
                        productId: null,
                        productName: nameInput.value.trim(),
                        quantity: parseInt(qtyInput.value) || 1,
                        price: parseFloat(priceInput.value) || 0
                    });
                }
            });
            if (items.length === 0) return alert('Agreg√° al menos un producto');

            const fileInput = document.getElementById('ticketPhoto');
            const file = fileInput.files[0];

            const orderData = {
                id: orderIdHidden.value || undefined,
                customerId,
                date: orderDate.value,
                status: orderStatus.value,
                comments: orderComments.value,
                items,
                ticketPhoto: ''
            };

            await saveOrder(orderData, file);
            orderModal.style.display = 'none';
        });

        ticketPhoto.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    photoPreviewContainer.innerHTML = `<img src="${ev.target.result}" class="photo-preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        addProductBtn.addEventListener('click', () => addProductRow());

        quickAddCustomerBtn.addEventListener('click', () => {
            quickCustomerForm.reset();
            quickCustomerModal.style.display = 'flex';
        });

        cancelQuickBtn.addEventListener('click', () => quickCustomerModal.style.display = 'none');

        quickCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCust = {
                name: quickName.value.trim(),
                phone: quickPhone.value.trim(),
                address: quickAddress.value.trim(),
                email: quickEmail.value.trim()
            };
            if (!newCust.name) return alert('El nombre es obligatorio');
            await saveCustomer(newCust);
            quickCustomerModal.style.display = 'none';
        });

        function openCustomerModal(id = null) {
            customerModalTitle.innerText = id ? '‚úèÔ∏è Editar Cliente' : 'üë§ Nuevo Cliente';
            customerForm.reset();
            customerIdHidden.value = '';
            if (id) {
                const cust = customers.find(c => c.id === id);
                if (cust) {
                    customerIdHidden.value = cust.id;
                    customerName.value = cust.name;
                    customerPhone.value = cust.phone || '';
                    customerAddress.value = cust.address || '';
                    customerEmail.value = cust.email || '';
                }
            }
            customerModal.style.display = 'flex';
        }

        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const custData = {
                id: customerIdHidden.value || undefined,
                name: customerName.value.trim(),
                phone: customerPhone.value.trim(),
                address: customerAddress.value.trim(),
                email: customerEmail.value.trim()
            };
            if (!custData.name) return alert('El nombre es obligatorio');
            await saveCustomer(custData);
            customerModal.style.display = 'none';
        });

        cancelCustomerBtn.addEventListener('click', () => customerModal.style.display = 'none');
        newCustomerBtn.addEventListener('click', () => openCustomerModal());
        newOrderBtn.addEventListener('click', () => openOrderModal());

        searchOrders.addEventListener('input', renderOrders);
        statusFilter.addEventListener('change', renderOrders);
        dateFrom.addEventListener('change', renderOrders);
        dateTo.addEventListener('change', renderOrders);

        // --- NUEVO: Manejador de archivo mejorado con progreso ---
        function handleProductFile(file) {
            const reader = new FileReader();
            const fileType = file.name.split('.').pop().toLowerCase();
            
            dropZone.innerHTML = `<span class="spinner"></span> Procesando archivo... (0%)`;
            dropZone.style.pointerEvents = 'none';

            const updateProgress = (percent) => {
                dropZone.innerHTML = `<span class="spinner"></span> Procesando archivo... (${percent}%)`;
            };

            if (fileType === 'csv') {
                reader.onload = async (ev) => {
                    try {
                        const newProducts = parseCSV(ev.target.result);
                        await importProducts(newProducts);
                        resetDropZone('‚úÖ Productos cargados correctamente');
                    } catch (err) {
                        console.error(err);
                        alert('Error al leer CSV: ' + err.message);
                        resetDropZone();
                    } finally {
                        dropZone.style.pointerEvents = 'auto';
                    }
                };
                reader.readAsText(file);
            } else if (fileType === 'xls' || fileType === 'xlsx') {
                reader.onload = async (ev) => {
                    try {
                        const data = new Uint8Array(ev.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        if (rows.length < 2) throw new Error('El archivo no tiene datos');
                        
                        const headers = rows[0].map(h => String(h).toLowerCase().trim());
                        const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto' || h === 'productos');
                        const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe') || h === 'costo');
                        if (nameIdx === -1) throw new Error('No se encontr√≥ una columna de "nombre" o "producto"');

                        const newProducts = [];
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row || row.length === 0) continue;
                            const name = row[nameIdx] ? String(row[nameIdx]).trim() : '';
                            if (!name) continue;
                            let price = undefined;
                            if (priceIdx !== -1 && row[priceIdx] !== undefined) {
                                const val = row[priceIdx];
                                if (typeof val === 'number') price = val;
                                else if (typeof val === 'string') {
                                    const num = parseFloat(val.replace(/[^\d.,-]/g, '').replace(',', '.'));
                                    if (!isNaN(num)) price = num;
                                }
                            }
                            newProducts.push({ name, price });
                            
                            if (i % 100 === 0) {
                                updateProgress(Math.round((i / rows.length) * 100));
                            }
                        }
                        
                        updateProgress(100);
                        await importProducts(newProducts);
                        resetDropZone('‚úÖ Productos cargados correctamente');
                    } catch (err) {
                        console.error(err);
                        alert('Error al leer Excel: ' + err.message);
                        resetDropZone();
                    } finally {
                        dropZone.style.pointerEvents = 'auto';
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('Formato no soportado. Us√° CSV o Excel.');
                resetDropZone();
                dropZone.style.pointerEvents = 'auto';
            }
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const nameIdx = headers.findIndex(h => h.includes('nombre') || h === 'producto');
            const priceIdx = headers.findIndex(h => h.includes('precio') || h.includes('importe'));
            if (nameIdx === -1) throw new Error('El CSV debe tener una columna "nombre" o "producto"');
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length <= nameIdx) continue;
                const name = values[nameIdx];
                if (!name) continue;
                let price = undefined;
                if (priceIdx !== -1 && values[priceIdx]) {
                    const num = parseFloat(values[priceIdx].replace(/[^\d.,-]/g, '').replace(',', '.'));
                    if (!isNaN(num)) price = num;
                }
                result.push({ name, price });
            }
            return result;
        }

        function resetDropZone(message = 'üìÇ Arrastr√° o hac√© clic para seleccionar archivo (CSV o Excel)') {
            dropZone.innerHTML = message;
            dropZone.style.pointerEvents = 'auto';
        }

        dropZone.addEventListener('click', () => productFile.click());
        dropZone.addEventListener('dragover', (e) => e.preventDefault());
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) handleProductFile(file);
        });
        productFile.addEventListener('change', (e) => {
            if (e.target.files[0]) handleProductFile(e.target.files[0]);
        });

        clearProductsBtn.addEventListener('click', clearAllProducts);

        exportBackupBtn.addEventListener('click', exportBackup);

        importZone.addEventListener('click', () => importFile.click());
        importZone.addEventListener('dragover', (e) => e.preventDefault());
        importZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) importBackup(file);
        });
        importFile.addEventListener('change', (e) => {
            if (e.target.files[0]) importBackup(e.target.files[0]);
        });

        const datalist = document.createElement('datalist');
        datalist.id = 'productDatalist';
        document.body.appendChild(datalist);
        function updateProductDatalist() {
            datalist.innerHTML = products.map(p => `<option value="${p.name}">${p.price ? '$'+p.price : ''}</option>`).join('');
        }

        document.querySelector('#imageModal .close').addEventListener('click', () => imageModal.style.display = 'none');

        // Inicializaci√≥n
        loadAllData().then(() => {
            startSubscriptions();
            setActiveView('orders');
        });
    })();
</script>
